<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1">


<meta name="date" content="2019-12-13" />

<title>Elements for implementing a crop model R wrapper</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>



<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#header {
text-align: center;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; }  code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Elements for implementing a crop model R wrapper</h1>
<h4 class="author">Patrice Lecharpentier</h4>
<address class="author_afil">
INRA - Agroclim<br><h4 class="author">Samuel Buis</h4>
<address class="author_afil">
INRA - EMMAH<br><h4 class="date">2019-12-13</h4>



<div id="introduction" class="section level2">
<h2>Introduction</h2>
<p>Talk about the contexts of use of this wrapper and // computations.</p>
</div>
<div id="definition" class="section level2">
<h2>Definition</h2>
<p>The R model wrapper aims to use the original model code/executable file (or using other mechanisms depending on the model)… with specific conditions (input files or data) defined for simulations situations (i.e. local conditions as model parameters and wheather data, initializations of state variables at the simulation starting point/date).</p>
<p>One can provide as supplemental inputs, parameters values for overloading default values (got from files, …) and output definition list for different situations (desired variables values for dates list).</p>
<p>The wrapper is composed of several functionnalities:</p>
<ul>
<li><p>Using specific model options</p></li>
<li><p>Forcing external parameters values</p></li>
<li><p>Working on multiple situations</p></li>
<li><p>Performing parallel calculations (optionally)</p></li>
<li><p>Selecting outputs or not (specific for each situation)</p></li>
<li><p>Running the model</p></li>
<li><p>Gathering all outputs</p></li>
</ul>
</div>
<div id="writing-the-model-wrapper" class="section level2">
<h2>Writing the model wrapper</h2>
<div id="function-input-arguments" class="section level3">
<h3>Function input arguments</h3>
<p>The names used are just examples to illustrate things.</p>
<div id="parameters-values" class="section level4">
<h4>Parameters values</h4>
<ul>
<li>name: <strong>param_values</strong></li>
<li><em>optional argument</em></li>
<li>a <code>named vector</code> of parameters to be forced in the model inputs</li>
</ul>
</div>
<div id="variables-and-dates-situation-list" class="section level4">
<h4>Variables and dates situation list</h4>
<ul>
<li>name: <strong>site_var_dates_mask</strong></li>
<li><em>optional argument</em></li>
<li>a <code>named list</code> (names == situations names) of tables (i.e. data.frames) containing measured values for the variables or a number for the desired combination var/dates and NA in other cases.</li>
</ul>
</div>
<div id="prior-information-for-managing-forcing-parameters" class="section level4">
<h4>Prior information for managing forcing parameters</h4>
<ul>
<li>name: <strong>prior_information</strong></li>
<li><em>optional argument</em></li>
<li>a <code>named list</code> with parameters names fields containing informations used for defining what specific parameters/values to use for a given situation and/or associated parameters bounds (per parameter or parameters repetition associated to situations groups)</li>
</ul>
</div>
<div id="model-options-list" class="section level4">
<h4>Model options list</h4>
<ul>
<li>name: <strong>model_options</strong></li>
<li><em>mandatory argument</em></li>
<li>a <code>named list</code> of needed informations about the model (see next section for details)</li>
</ul>
</div>
<div id="function-header-example" class="section level4">
<h4>Function header example</h4>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" title="1"><span class="co">#&#39; @title Running situation(s) from txt input files stored in one directory</span></a>
<a class="sourceLine" id="cb1-2" title="2"><span class="co">#&#39; per `situation`, simulated results are returned in a list</span></a>
<a class="sourceLine" id="cb1-3" title="3"><span class="co">#&#39;</span></a>
<a class="sourceLine" id="cb1-4" title="4"><span class="co">#&#39; @description This function uses the model directly through a system call, can</span></a>
<a class="sourceLine" id="cb1-5" title="5"><span class="co">#&#39; force model input parameters with values given in arguments.</span></a>
<a class="sourceLine" id="cb1-6" title="6"><span class="co">#&#39;</span></a>
<a class="sourceLine" id="cb1-7" title="7"><span class="co">#&#39; @param param_values named vector containing the value(s) and names of the</span></a>
<a class="sourceLine" id="cb1-8" title="8"><span class="co">#&#39; parameters to force (optional)</span></a>
<a class="sourceLine" id="cb1-9" title="9"><span class="co">#&#39;</span></a>
<a class="sourceLine" id="cb1-10" title="10"><span class="co">#&#39; @param site_var_dates_mask List of situations, variables and dates for which</span></a>
<a class="sourceLine" id="cb1-11" title="11"><span class="co">#&#39; simulated values should be returned. Typically a list containing the</span></a>
<a class="sourceLine" id="cb1-12" title="12"><span class="co">#&#39; observations to which simulations should be compared</span></a>
<a class="sourceLine" id="cb1-13" title="13"><span class="co">#&#39; (i.e. a list of variables/dates per situation)</span></a>
<a class="sourceLine" id="cb1-14" title="14"><span class="co">#&#39;</span></a>
<a class="sourceLine" id="cb1-15" title="15"><span class="co">#&#39; @param prior_information Prior information on the parameters to estimate.</span></a>
<a class="sourceLine" id="cb1-16" title="16"><span class="co">#&#39; For the moment only uniform distribution are allowed.</span></a>
<a class="sourceLine" id="cb1-17" title="17"><span class="co">#&#39; Either a list containing (named) vectors of upper and lower</span></a>
<a class="sourceLine" id="cb1-18" title="18"><span class="co">#&#39; bounds (\code{ub} and \code{lb}), or a named list containing for each</span></a>
<a class="sourceLine" id="cb1-19" title="19"><span class="co">#&#39; parameter the list of situations per group (\code{sit_list})</span></a>
<a class="sourceLine" id="cb1-20" title="20"><span class="co">#&#39; and the vector of upper and lower bounds (one value per group) (\code{ub} and \code{lb})</span></a>
<a class="sourceLine" id="cb1-21" title="21"><span class="co">#&#39;</span></a>
<a class="sourceLine" id="cb1-22" title="22"><span class="co">#&#39; @param model_options List containing any information needed by the model.</span></a>
<a class="sourceLine" id="cb1-23" title="23"><span class="co">#&#39; For example: the path of the model executable file,</span></a>
<a class="sourceLine" id="cb1-24" title="24"><span class="co">#&#39; the path of the directory containing input data</span></a>
<a class="sourceLine" id="cb1-25" title="25"><span class="co">#&#39;</span></a>
<a class="sourceLine" id="cb1-26" title="26"><span class="co">#&#39; @return A list containing simulated values (\code{sim_list}) and a flag</span></a>
<a class="sourceLine" id="cb1-27" title="27"><span class="co">#&#39; (\code{flag_allsim}) indicating if all required situations, variables and</span></a>
<a class="sourceLine" id="cb1-28" title="28"><span class="co">#&#39; dates were simulated.</span></a>
<a class="sourceLine" id="cb1-29" title="29"></a>
<a class="sourceLine" id="cb1-30" title="30">model_wrapper &lt;-<span class="st"> </span><span class="cf">function</span>( <span class="dt">param_values=</span><span class="ot">NULL</span>, <span class="dt">site_var_dates_mask=</span><span class="ot">NULL</span>,</a>
<a class="sourceLine" id="cb1-31" title="31">                           <span class="dt">prior_information=</span><span class="ot">NULL</span>, model_options ) {</a>
<a class="sourceLine" id="cb1-32" title="32">  ...</a>
<a class="sourceLine" id="cb1-33" title="33">  </a>
<a class="sourceLine" id="cb1-34" title="34">}</a></code></pre></div>
</div>
</div>
<div id="defining-a-model-options-list" class="section level3">
<h3>Defining a model options list</h3>
<div id="aim" class="section level4">
<h4>Aim</h4>
<p>The use of this options list is for masking model specific informations when the wrapper function is called automatically by functions managing parameters values forcing. In this case the options list is only transmitted to the model wrapper.</p>
<p>This is usefull for <code>sensitivity analysis</code> or <code>optimization</code> processes cases, for example.</p>
</div>
<div id="list-structure" class="section level4">
<h4>List structure</h4>
<ul>
<li>Mandatory informations needed by the model for functionning<br />
<strong>For example</strong>
<ul>
<li>inputs data directory path/root path</li>
<li>model executable location path</li>
<li>…</li>
</ul></li>
<li>Additional (optional) informations modifying the wrapper behaviour<br />
<strong>For example</strong>
<ul>
<li>parallel calculation management</li>
<li>information display management (for example: runs duration)</li>
<li>warning display management</li>
<li>…</li>
</ul></li>
</ul>
</div>
<div id="example-of-a-model-options-interface-function" class="section level4">
<h4>Example of a model options interface function</h4>
<blockquote>
<p>Based on a model example used with a simple system call</p>
</blockquote>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" title="1">model_wrapper_options &lt;-<span class="st"> </span><span class="cf">function</span>(model_path,</a>
<a class="sourceLine" id="cb2-2" title="2">                                  data_dir, ... ) {</a>
<a class="sourceLine" id="cb2-3" title="3">  </a>
<a class="sourceLine" id="cb2-4" title="4">  <span class="co"># options list template</span></a>
<a class="sourceLine" id="cb2-5" title="5">  options &lt;-<span class="st"> </span><span class="kw">list</span>()</a>
<a class="sourceLine" id="cb2-6" title="6">  <span class="co"># model executable</span></a>
<a class="sourceLine" id="cb2-7" title="7">  options<span class="op">$</span>model_path &lt;-<span class="st"> </span><span class="kw">character</span>(<span class="dv">0</span>)</a>
<a class="sourceLine" id="cb2-8" title="8">  <span class="co"># input data</span></a>
<a class="sourceLine" id="cb2-9" title="9">  options<span class="op">$</span>data_dir &lt;-<span class="st"> </span><span class="kw">character</span>(<span class="dv">0</span>)</a>
<a class="sourceLine" id="cb2-10" title="10">  <span class="co"># parallel calculation switch</span></a>
<a class="sourceLine" id="cb2-11" title="11">  options<span class="op">$</span>parallel &lt;-<span class="st"> </span><span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb2-12" title="12">  <span class="co"># setting cores number</span></a>
<a class="sourceLine" id="cb2-13" title="13">  options<span class="op">$</span>cores &lt;-<span class="st"> </span><span class="ot">NA</span></a>
<a class="sourceLine" id="cb2-14" title="14">  <span class="co"># duration time display switch</span></a>
<a class="sourceLine" id="cb2-15" title="15">  options<span class="op">$</span>time_display &lt;-<span class="st"> </span><span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb2-16" title="16">  <span class="co"># warning display switch</span></a>
<a class="sourceLine" id="cb2-17" title="17">  options<span class="op">$</span>warning_display &lt;-<span class="st"> </span><span class="ot">TRUE</span></a>
<a class="sourceLine" id="cb2-18" title="18">  </a>
<a class="sourceLine" id="cb2-19" title="19">  <span class="co"># Getting the options list template content</span></a>
<a class="sourceLine" id="cb2-20" title="20">  <span class="co"># when running model_wrapper_options()</span></a>
<a class="sourceLine" id="cb2-21" title="21">  <span class="cf">if</span> (<span class="op">!</span><span class="st"> </span><span class="kw">nargs</span>()) <span class="kw">return</span>(options)</a>
<a class="sourceLine" id="cb2-22" title="22">  </a>
<a class="sourceLine" id="cb2-23" title="23">  <span class="co"># Fixing mandatory fields values</span></a>
<a class="sourceLine" id="cb2-24" title="24">  options<span class="op">$</span>model_path &lt;-<span class="st"> </span>model_path</a>
<a class="sourceLine" id="cb2-25" title="25">  options<span class="op">$</span>data_dir &lt;-<span class="st"> </span>data_dir</a>
<a class="sourceLine" id="cb2-26" title="26">  </a>
<a class="sourceLine" id="cb2-27" title="27">  <span class="co"># Fixing optional fields:</span></a>
<a class="sourceLine" id="cb2-28" title="28">  <span class="co"># if names in given list (...) correspond</span></a>
<a class="sourceLine" id="cb2-29" title="29">  <span class="co"># to exact field names in options list</span></a>
<a class="sourceLine" id="cb2-30" title="30">  list_names &lt;-<span class="st"> </span><span class="kw">names</span> (options)</a>
<a class="sourceLine" id="cb2-31" title="31">  add_args &lt;-<span class="st"> </span><span class="kw">list</span>(...)</a>
<a class="sourceLine" id="cb2-32" title="32">  </a>
<a class="sourceLine" id="cb2-33" title="33">  <span class="cf">for</span> (n <span class="cf">in</span> <span class="kw">names</span>(add_args)) {</a>
<a class="sourceLine" id="cb2-34" title="34">    <span class="cf">if</span> ( n <span class="op">%in%</span><span class="st"> </span>list_names) {</a>
<a class="sourceLine" id="cb2-35" title="35">      options[[n]] &lt;-<span class="st"> </span>add_args[[n]]</a>
<a class="sourceLine" id="cb2-36" title="36">    }</a>
<a class="sourceLine" id="cb2-37" title="37">  }</a>
<a class="sourceLine" id="cb2-38" title="38">  </a>
<a class="sourceLine" id="cb2-39" title="39">  <span class="kw">return</span>(options)</a>
<a class="sourceLine" id="cb2-40" title="40">}</a></code></pre></div>
</div>
</div>
<div id="the-output-mask-i.e.-site_var_dates_mask" class="section level3">
<h3>The output mask (i.e. site_var_dates_mask)</h3>
<p>The waited structure by the wrapper is for the moment a list of data frames (one for each situation) crossing a list of variables with a list of dates, per situation. In the wrapper, only variables names and Dates list are used for reducing output data.frames for situations. Data.frame content is not usefull for the treament at all.</p>
<blockquote>
<p>At the moment, this structure is identical either produced from the observations data or made independently from those.</p>
</blockquote>
<p>But this structure will certainly change in the future, to minimize stored information, keeping only the usefull data for selecting output data (optimizing memory storage, process)</p>
<p>For example, from a list of observation files (useful for evaluation or optimization processes), a named list of data.frame is produced, one for each situation for which the file exists.</p>
<p>Here is an example for a single file for <code>banana</code> observations:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" title="1"><span class="kw">library</span>(SticsRFiles)</a>
<a class="sourceLine" id="cb3-2" title="2">path &lt;-<span class="st"> </span><span class="kw">system.file</span>(<span class="kw">file.path</span>(<span class="st">&quot;extdata&quot;</span>,<span class="st">&quot;obs&quot;</span>,<span class="st">&quot;V9.0&quot;</span>), <span class="dt">package =</span> <span class="st">&quot;SticsRFiles&quot;</span>)</a>
<a class="sourceLine" id="cb3-3" title="3">obs_list &lt;-<span class="st"> </span><span class="kw">read_obs</span>(path)</a>
<a class="sourceLine" id="cb3-4" title="4"><span class="kw">lapply</span>(obs_list, <span class="cf">function</span>(x) <span class="kw">head</span>(x,<span class="dv">4</span>))</a></code></pre></div>
<p>One can give a similar filter list structure defining a customized selection of variables and Dates, but with all values set to NA in data.frames.</p>
</div>
<div id="actions-to-be-performed-by-the-model-wrapper" class="section level3">
<h3>Actions to be performed by the model wrapper</h3>
<div id="before-the-loop-over-situations-list" class="section level4">
<h4>Before the loop over situations list</h4>
<ul>
<li>Managing options: checks about its content, reacting from values stored in it<br />
<strong>For example</strong>:
<ul>
<li>checking if paths exist</li>
<li>checking the model executable, its version, …(libraries availability, …)</li>
<li>storing fields contents in simple variables (easier to use)</li>
<li>other kinds of checks or calculations (depending on the model specificities)</li>
</ul></li>
</ul>
</div>
<div id="inside-the-loop-over-situations-list" class="section level4">
<h4>Inside the loop over situations list</h4>
<ol style="list-style-type: decimal">
<li>Managing parameters forcing</li>
</ol>
<p>From the <code>param_values</code> argument, use a mechanism to force values in the model inputs:</p>
<ul>
<li>replacing values in original parameters file(s)</li>
<li>specific file dedicated to force parameters (exists in Stics)</li>
<li>passing parameters values through an interface function to the model (for example R -&gt; cpp, fortran,… libraries)</li>
<li>…</li>
</ul>
<p>The parameters values may be associated with data (<code>prior_information</code>) describing which values for which parameters must be applied to each situation extracted from the parameters values vector <code>param_values</code>.</p>
<p>If <code>prior_information</code> contains the default value (NULL) the same set of parameter values is used for each situation.</p>
<ul>
<li>Example of information stored in <code>prior_information</code> and use:</li>
</ul>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" title="1"><span class="kw">library</span>(SticsOptimizR)</a>
<a class="sourceLine" id="cb4-2" title="2">sg=<span class="kw">list</span>(<span class="dt">p1=</span><span class="kw">list</span>(<span class="dt">sit_list=</span><span class="kw">list</span>(<span class="kw">c</span>(<span class="st">&quot;sit1&quot;</span>,<span class="st">&quot;sit2&quot;</span>,<span class="st">&quot;sit3&quot;</span>),<span class="kw">c</span>(<span class="st">&quot;sit4&quot;</span>,<span class="st">&quot;sit5&quot;</span>,<span class="st">&quot;sit6&quot;</span>))),</a>
<a class="sourceLine" id="cb4-3" title="3">        <span class="dt">p2=</span><span class="kw">list</span>(<span class="dt">sit_list=</span><span class="kw">list</span>(<span class="kw">c</span>(<span class="st">&quot;sit1&quot;</span>,<span class="st">&quot;sit2&quot;</span>,<span class="st">&quot;sit3&quot;</span>,<span class="st">&quot;sit4&quot;</span>,<span class="st">&quot;sit5&quot;</span>,<span class="st">&quot;sit6&quot;</span>))))</a>
<a class="sourceLine" id="cb4-4" title="4"></a>
<a class="sourceLine" id="cb4-5" title="5">vec=<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>)</a>
<a class="sourceLine" id="cb4-6" title="6"></a>
<a class="sourceLine" id="cb4-7" title="7"><span class="kw">names</span>(vec) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;p2&quot;</span>,<span class="st">&quot;p1&quot;</span>,<span class="st">&quot;p1&quot;</span>)</a>
<a class="sourceLine" id="cb4-8" title="8"></a>
<a class="sourceLine" id="cb4-9" title="9">params_sit2 &lt;-<span class="st"> </span><span class="kw">get_params_per_sit</span>(sg,<span class="st">&quot;sit2&quot;</span>,vec)</a>
<a class="sourceLine" id="cb4-10" title="10"></a>
<a class="sourceLine" id="cb4-11" title="11">params_sit2</a></code></pre></div>
<ol start="2" style="list-style-type: decimal">
<li>Running the model</li>
</ol>
<p>Using a model interface function with a system call or other mechanisms to perform a model run for a situation and get back execution error status.</p>
<ol start="3" style="list-style-type: decimal">
<li>Getting output data</li>
</ol>
<p>If the model run produces files, a function is used to read and format the date/variables outputs. Otherwise the results may be produced directly by an R model function and are to be formatted as expected too.</p>
<ol start="4" style="list-style-type: decimal">
<li>Selecting output data If the optional argument <code>site_var_dates_mask</code> is used to filter data in outputs situations tables, a subset based on rows dates values for columns names (i.e. variables) of site_var_dates_mask is used for each situation.</li>
</ol>
</div>
<div id="managing-optional-parallel-computations-inside-the-loop" class="section level4">
<h4>Managing optional parallel computations inside the loop</h4>
<p>The doParallel package is used and there are specificities when doing a parallel loop especially that a pre allocated list outide of the loop is not shared between cores so return statements must be used inside.</p>
<p>Here is an example for illustrating what happens:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" title="1"><span class="co"># Code of an example of foreach loop algo</span></a>
<a class="sourceLine" id="cb5-2" title="2"><span class="kw">library</span>(<span class="st">&quot;doParallel&quot;</span>)</a>
<a class="sourceLine" id="cb5-3" title="3"><span class="kw">print</span>(params<span class="op">$</span>cores_nb)</a>
<a class="sourceLine" id="cb5-4" title="4"></a>
<a class="sourceLine" id="cb5-5" title="5">test_parallel &lt;-<span class="st"> </span><span class="cf">function</span>(<span class="dt">cores_nb =</span> <span class="dv">1</span>,</a>
<a class="sourceLine" id="cb5-6" title="6">                          <span class="dt">pa =</span> <span class="ot">FALSE</span>,</a>
<a class="sourceLine" id="cb5-7" title="7">                          <span class="dt">max_it =</span> <span class="dv">5</span>) {</a>
<a class="sourceLine" id="cb5-8" title="8">  </a>
<a class="sourceLine" id="cb5-9" title="9">  <span class="co"># Launching the cluster</span></a>
<a class="sourceLine" id="cb5-10" title="10">  cl &lt;-<span class="st"> </span><span class="kw">makeCluster</span>(cores_nb)</a>
<a class="sourceLine" id="cb5-11" title="11">  <span class="kw">registerDoParallel</span>(cl)</a>
<a class="sourceLine" id="cb5-12" title="12">  </a>
<a class="sourceLine" id="cb5-13" title="13">  <span class="co"># List preallocation</span></a>
<a class="sourceLine" id="cb5-14" title="14">  out_pa &lt;-<span class="st"> </span><span class="kw">vector</span>(<span class="dt">mode =</span> <span class="st">&quot;list&quot;</span>, max_it)</a>
<a class="sourceLine" id="cb5-15" title="15">  </a>
<a class="sourceLine" id="cb5-16" title="16">  <span class="co"># Parallel loop</span></a>
<a class="sourceLine" id="cb5-17" title="17">  out &lt;-<span class="st"> </span><span class="kw">foreach</span>(<span class="dt">i =</span> <span class="dv">1</span><span class="op">:</span>max_it) <span class="op">%dopar%</span><span class="st"> </span>{</a>
<a class="sourceLine" id="cb5-18" title="18">    <span class="cf">if</span> (pa) {</a>
<a class="sourceLine" id="cb5-19" title="19">      out_pa[[i]] &lt;-<span class="st"> </span>i</a>
<a class="sourceLine" id="cb5-20" title="20">    } <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb5-21" title="21">      <span class="kw">return</span>(i)</a>
<a class="sourceLine" id="cb5-22" title="22">    }</a>
<a class="sourceLine" id="cb5-23" title="23">  }</a>
<a class="sourceLine" id="cb5-24" title="24">  </a>
<a class="sourceLine" id="cb5-25" title="25">  <span class="co"># Stopping the cluster</span></a>
<a class="sourceLine" id="cb5-26" title="26">  <span class="kw">stopCluster</span>(cl)</a>
<a class="sourceLine" id="cb5-27" title="27">  </a>
<a class="sourceLine" id="cb5-28" title="28">  <span class="cf">if</span> (pa) {</a>
<a class="sourceLine" id="cb5-29" title="29">    <span class="kw">return</span>(out_pa)</a>
<a class="sourceLine" id="cb5-30" title="30">  } <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb5-31" title="31">    <span class="kw">return</span>(out)</a>
<a class="sourceLine" id="cb5-32" title="32">  }</a>
<a class="sourceLine" id="cb5-33" title="33">  </a>
<a class="sourceLine" id="cb5-34" title="34">  </a>
<a class="sourceLine" id="cb5-35" title="35">}</a>
<a class="sourceLine" id="cb5-36" title="36"></a>
<a class="sourceLine" id="cb5-37" title="37">out &lt;-<span class="st"> </span><span class="kw">test_parallel</span>(params<span class="op">$</span>cores_nb)</a>
<a class="sourceLine" id="cb5-38" title="38"></a>
<a class="sourceLine" id="cb5-39" title="39">out_pa &lt;-<span class="st"> </span><span class="kw">test_parallel</span>(params<span class="op">$</span>cores_nb, <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb5-40" title="40"></a>
<a class="sourceLine" id="cb5-41" title="41">out</a>
<a class="sourceLine" id="cb5-42" title="42"></a>
<a class="sourceLine" id="cb5-43" title="43">out_pa</a></code></pre></div>
<p>There are also differences with managing warnings and displays in a parallel context. They must be stored in the return list and treated after the loop.</p>
</div>
<div id="returning-data-for-all-situations" class="section level4">
<h4>Returning data for all situations</h4>
<blockquote>
<p>temporary structure: named list of data.frames, and simulation status flag.</p>
</blockquote>
<p>The wrapper return a list/collection of situation simulations outputs (filtered or not), for the successful simulations. There is also a simulation status return indicating if all simulations ran successfully or not.</p>
</div>
</div>
</div>
<div id="examples-of-use-of-model-wrapper" class="section level2">
<h2>Examples of use of model wrapper</h2>
<p>TODO</p>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
