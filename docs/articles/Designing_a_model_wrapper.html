<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Elements for implementing a crop model R wrapper • CroptimizR</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Elements for implementing a crop model R wrapper">
<meta property="og:description" content="">
<meta property="og:image" content="/logo.png">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">CroptimizR</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/ApsimX_parameter_estimation_simple_case.html">Parameter estimation with the ApsimX crop Model: a simple case</a>
    </li>
    <li>
      <a href="../articles/Designing_a_model_wrapper.html">Elements for implementing a crop model R wrapper</a>
    </li>
    <li>
      <a href="../articles/Parameter_estimation_simple_case.html">Parameter estimation with the Stics crop Model: a simple case</a>
    </li>
    <li>
      <a href="../articles/Parameter_estimation_Specific_and_Varietal.html">Parameter estimation with the Stics crop Model: a case with specific and varietal parameters</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/SticsRPacks/CroptimizR">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Elements for implementing a crop model R wrapper</h1>
                        <h4 class="author">Patrice Lecharpentier</h4>
            <address class="author_afil">
      INRA - Agroclim<br><h4 class="author">Samuel Buis</h4>
            <address class="author_afil">
      INRA - EMMAH<br><h4 class="date">2019-12-13</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/SticsRPacks/CroptimizR/blob/master/vignettes/Designing_a_model_wrapper.Rmd"><code>vignettes/Designing_a_model_wrapper.Rmd</code></a></small>
      <div class="hidden name"><code>Designing_a_model_wrapper.Rmd</code></div>

    </address>
</address>
</div>

    
    
<div id="introduction" class="section level2">
<h2 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h2>
<p>Talk about the contexts of use of this wrapper and // computations.</p>
</div>
<div id="definition" class="section level2">
<h2 class="hasAnchor">
<a href="#definition" class="anchor"></a>Definition</h2>
<p>The R model wrapper aims to use the original model code/executable file (or using other mechanisms depending on the model)… with specific conditions (input files or data) defined for simulations situations (i.e. local conditions as model parameters and wheather data, initializations of state variables at the simulation starting point/date).</p>
<p>One can provide as supplemental inputs, parameters values for overloading default values (got from files, …) and output definition list for different situations (desired variables values for dates list).</p>
<p>The wrapper is composed of several functionnalities:</p>
<ul>
<li><p>Using specific model options</p></li>
<li><p>Forcing external parameters values</p></li>
<li><p>Working on multiple situations</p></li>
<li><p>Performing parallel calculations (optionally)</p></li>
<li><p>Selecting outputs or not (specific for each situation)</p></li>
<li><p>Running the model</p></li>
<li><p>Gathering all outputs</p></li>
</ul>
</div>
<div id="writing-the-model-wrapper" class="section level2">
<h2 class="hasAnchor">
<a href="#writing-the-model-wrapper" class="anchor"></a>Writing the model wrapper</h2>
<div id="function-input-arguments" class="section level3">
<h3 class="hasAnchor">
<a href="#function-input-arguments" class="anchor"></a>Function input arguments</h3>
<p>The names used are just examples to illustrate things.</p>
<div id="parameters-values" class="section level4">
<h4 class="hasAnchor">
<a href="#parameters-values" class="anchor"></a>Parameters values</h4>
<ul>
<li>name: <strong>param_values</strong>
</li>
<li><em>optional argument</em></li>
<li>a <code>named vector</code> of parameters to be forced in the model inputs</li>
</ul>
</div>
<div id="variables-and-dates-situation-list" class="section level4">
<h4 class="hasAnchor">
<a href="#variables-and-dates-situation-list" class="anchor"></a>Variables and dates situation list</h4>
<ul>
<li>name: <strong>site_var_dates_mask</strong>
</li>
<li><em>optional argument</em></li>
<li>a <code>named list</code> (names == situations names) of tables (i.e. data.frames) containing measured values for the variables or a number for the desired combination var/dates and NA in other cases.</li>
</ul>
</div>
<div id="prior-information-for-managing-forcing-parameters" class="section level4">
<h4 class="hasAnchor">
<a href="#prior-information-for-managing-forcing-parameters" class="anchor"></a>Prior information for managing forcing parameters</h4>
<ul>
<li>name: <strong>prior_information</strong>
</li>
<li><em>optional argument</em></li>
<li>a <code>named list</code> with parameters names fields containing informations used for defining what specific parameters/values to use for a given situation and/or associated parameters bounds (per parameter or parameters repetition associated to situations groups)</li>
</ul>
</div>
<div id="model-options-list" class="section level4">
<h4 class="hasAnchor">
<a href="#model-options-list" class="anchor"></a>Model options list</h4>
<ul>
<li>name: <strong>model_options</strong>
</li>
<li><em>mandatory argument</em></li>
<li>a <code>named list</code> of needed informations about the model (see next section for details)</li>
</ul>
</div>
<div id="function-header-example" class="section level4">
<h4 class="hasAnchor">
<a href="#function-header-example" class="anchor"></a>Function header example</h4>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="co">#' @title Running situation(s) from txt input files stored in one directory</span></span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="co">#' per `situation`, simulated results are returned in a list</span></span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="co">#'</span></span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="co">#' @description This function uses the model directly through a system call, can</span></span>
<span id="cb1-5"><a href="#cb1-5"></a><span class="co">#' force model input parameters with values given in arguments.</span></span>
<span id="cb1-6"><a href="#cb1-6"></a><span class="co">#'</span></span>
<span id="cb1-7"><a href="#cb1-7"></a><span class="co">#' @param param_values named vector containing the value(s) and names of the</span></span>
<span id="cb1-8"><a href="#cb1-8"></a><span class="co">#' parameters to force (optional)</span></span>
<span id="cb1-9"><a href="#cb1-9"></a><span class="co">#'</span></span>
<span id="cb1-10"><a href="#cb1-10"></a><span class="co">#' @param site_var_dates_mask List of situations, variables and dates for which</span></span>
<span id="cb1-11"><a href="#cb1-11"></a><span class="co">#' simulated values should be returned. Typically a list containing the</span></span>
<span id="cb1-12"><a href="#cb1-12"></a><span class="co">#' observations to which simulations should be compared</span></span>
<span id="cb1-13"><a href="#cb1-13"></a><span class="co">#' (i.e. a list of variables/dates per situation)</span></span>
<span id="cb1-14"><a href="#cb1-14"></a><span class="co">#'</span></span>
<span id="cb1-15"><a href="#cb1-15"></a><span class="co">#' @param prior_information Prior information on the parameters to estimate.</span></span>
<span id="cb1-16"><a href="#cb1-16"></a><span class="co">#' For the moment only uniform distribution are allowed.</span></span>
<span id="cb1-17"><a href="#cb1-17"></a><span class="co">#' Either a list containing (named) vectors of upper and lower</span></span>
<span id="cb1-18"><a href="#cb1-18"></a><span class="co">#' bounds (\code{ub} and \code{lb}), or a named list containing for each</span></span>
<span id="cb1-19"><a href="#cb1-19"></a><span class="co">#' parameter the list of situations per group (\code{sit_list})</span></span>
<span id="cb1-20"><a href="#cb1-20"></a><span class="co">#' and the vector of upper and lower bounds (one value per group) (\code{ub} and \code{lb})</span></span>
<span id="cb1-21"><a href="#cb1-21"></a><span class="co">#'</span></span>
<span id="cb1-22"><a href="#cb1-22"></a><span class="co">#' @param model_options List containing any information needed by the model.</span></span>
<span id="cb1-23"><a href="#cb1-23"></a><span class="co">#' For example: the path of the model executable file,</span></span>
<span id="cb1-24"><a href="#cb1-24"></a><span class="co">#' the path of the directory containing input data</span></span>
<span id="cb1-25"><a href="#cb1-25"></a><span class="co">#'</span></span>
<span id="cb1-26"><a href="#cb1-26"></a><span class="co">#' @return A list containing simulated values (\code{sim_list}) and a flag</span></span>
<span id="cb1-27"><a href="#cb1-27"></a><span class="co">#' (\code{flag_allsim}) indicating if all required situations, variables and</span></span>
<span id="cb1-28"><a href="#cb1-28"></a><span class="co">#' dates were simulated.</span></span>
<span id="cb1-29"><a href="#cb1-29"></a></span>
<span id="cb1-30"><a href="#cb1-30"></a>model_wrapper &lt;-<span class="st"> </span><span class="cf">function</span>( <span class="dt">param_values=</span><span class="ot">NULL</span>, <span class="dt">site_var_dates_mask=</span><span class="ot">NULL</span>,</span>
<span id="cb1-31"><a href="#cb1-31"></a>                           <span class="dt">prior_information=</span><span class="ot">NULL</span>, model_options ) {</span>
<span id="cb1-32"><a href="#cb1-32"></a>  ...</span>
<span id="cb1-33"><a href="#cb1-33"></a>  </span>
<span id="cb1-34"><a href="#cb1-34"></a>}</span></code></pre></div>
</div>
</div>
<div id="defining-a-model-options-list" class="section level3">
<h3 class="hasAnchor">
<a href="#defining-a-model-options-list" class="anchor"></a>Defining a model options list</h3>
<div id="aim" class="section level4">
<h4 class="hasAnchor">
<a href="#aim" class="anchor"></a>Aim</h4>
<p>The use of this options list is for masking model specific informations when the wrapper function is called automatically by functions managing parameters values forcing. In this case the options list is only transmitted to the model wrapper.</p>
<p>This is usefull for <code>sensitivity analysis</code> or <code>optimization</code> processes cases, for example.</p>
</div>
<div id="list-structure" class="section level4">
<h4 class="hasAnchor">
<a href="#list-structure" class="anchor"></a>List structure</h4>
<ul>
<li>Mandatory informations needed by the model for functionning<br><strong>For example</strong>
<ul>
<li>inputs data directory path/root path</li>
<li>model executable location path</li>
<li>…</li>
</ul>
</li>
<li>Additional (optional) informations modifying the wrapper behaviour<br><strong>For example</strong>
<ul>
<li>parallel calculation management</li>
<li>information display management (for example: runs duration)</li>
<li>warning display management</li>
<li>…</li>
</ul>
</li>
</ul>
</div>
<div id="example-of-a-model-options-interface-function" class="section level4">
<h4 class="hasAnchor">
<a href="#example-of-a-model-options-interface-function" class="anchor"></a>Example of a model options interface function</h4>
<blockquote>
<p>Based on a model example used with a simple system call</p>
</blockquote>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a>model_wrapper_options &lt;-<span class="st"> </span><span class="cf">function</span>(model_path,</span>
<span id="cb2-2"><a href="#cb2-2"></a>                                  data_dir, ... ) {</span>
<span id="cb2-3"><a href="#cb2-3"></a>  </span>
<span id="cb2-4"><a href="#cb2-4"></a>  <span class="co"># options list template</span></span>
<span id="cb2-5"><a href="#cb2-5"></a>  options &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>()</span>
<span id="cb2-6"><a href="#cb2-6"></a>  <span class="co"># model executable</span></span>
<span id="cb2-7"><a href="#cb2-7"></a>  options<span class="op">$</span>model_path &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/character">character</a></span>(<span class="dv">0</span>)</span>
<span id="cb2-8"><a href="#cb2-8"></a>  <span class="co"># input data</span></span>
<span id="cb2-9"><a href="#cb2-9"></a>  options<span class="op">$</span>data_dir &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/character">character</a></span>(<span class="dv">0</span>)</span>
<span id="cb2-10"><a href="#cb2-10"></a>  <span class="co"># parallel calculation switch</span></span>
<span id="cb2-11"><a href="#cb2-11"></a>  options<span class="op">$</span>parallel &lt;-<span class="st"> </span><span class="ot">FALSE</span></span>
<span id="cb2-12"><a href="#cb2-12"></a>  <span class="co"># setting cores number</span></span>
<span id="cb2-13"><a href="#cb2-13"></a>  options<span class="op">$</span>cores &lt;-<span class="st"> </span><span class="ot">NA</span></span>
<span id="cb2-14"><a href="#cb2-14"></a>  <span class="co"># duration time display switch</span></span>
<span id="cb2-15"><a href="#cb2-15"></a>  options<span class="op">$</span>time_display &lt;-<span class="st"> </span><span class="ot">FALSE</span></span>
<span id="cb2-16"><a href="#cb2-16"></a>  <span class="co"># warning display switch</span></span>
<span id="cb2-17"><a href="#cb2-17"></a>  options<span class="op">$</span>warning_display &lt;-<span class="st"> </span><span class="ot">TRUE</span></span>
<span id="cb2-18"><a href="#cb2-18"></a>  </span>
<span id="cb2-19"><a href="#cb2-19"></a>  <span class="co"># Getting the options list template content</span></span>
<span id="cb2-20"><a href="#cb2-20"></a>  <span class="co"># when running model_wrapper_options()</span></span>
<span id="cb2-21"><a href="#cb2-21"></a>  <span class="cf">if</span> (<span class="op">!</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/nargs">nargs</a></span>()) <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/function">return</a></span>(options)</span>
<span id="cb2-22"><a href="#cb2-22"></a>  </span>
<span id="cb2-23"><a href="#cb2-23"></a>  <span class="co"># Fixing mandatory fields values</span></span>
<span id="cb2-24"><a href="#cb2-24"></a>  options<span class="op">$</span>model_path &lt;-<span class="st"> </span>model_path</span>
<span id="cb2-25"><a href="#cb2-25"></a>  options<span class="op">$</span>data_dir &lt;-<span class="st"> </span>data_dir</span>
<span id="cb2-26"><a href="#cb2-26"></a>  </span>
<span id="cb2-27"><a href="#cb2-27"></a>  <span class="co"># Fixing optional fields:</span></span>
<span id="cb2-28"><a href="#cb2-28"></a>  <span class="co"># if names in given list (...) correspond</span></span>
<span id="cb2-29"><a href="#cb2-29"></a>  <span class="co"># to exact field names in options list</span></span>
<span id="cb2-30"><a href="#cb2-30"></a>  list_names &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/names">names</a></span> (options)</span>
<span id="cb2-31"><a href="#cb2-31"></a>  add_args &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(...)</span>
<span id="cb2-32"><a href="#cb2-32"></a>  </span>
<span id="cb2-33"><a href="#cb2-33"></a>  <span class="cf">for</span> (n <span class="cf">in</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/names">names</a></span>(add_args)) {</span>
<span id="cb2-34"><a href="#cb2-34"></a>    <span class="cf">if</span> ( n <span class="op">%in%</span><span class="st"> </span>list_names) {</span>
<span id="cb2-35"><a href="#cb2-35"></a>      options[[n]] &lt;-<span class="st"> </span>add_args[[n]]</span>
<span id="cb2-36"><a href="#cb2-36"></a>    }</span>
<span id="cb2-37"><a href="#cb2-37"></a>  }</span>
<span id="cb2-38"><a href="#cb2-38"></a>  </span>
<span id="cb2-39"><a href="#cb2-39"></a>  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/function">return</a></span>(options)</span>
<span id="cb2-40"><a href="#cb2-40"></a>}</span></code></pre></div>
</div>
</div>
<div id="the-output-mask-i-e--site_var_dates_mask" class="section level3">
<h3 class="hasAnchor">
<a href="#the-output-mask-i-e--site_var_dates_mask" class="anchor"></a>The output mask (i.e. site_var_dates_mask)</h3>
<p>The waited structure by the wrapper is for the moment a list of data frames (one for each situation) crossing a list of variables with a list of dates, per situation. In the wrapper, only variables names and Dates list are used for reducing output data.frames for situations. Data.frame content is not usefull for the treament at all.</p>
<blockquote>
<p>At the moment, this structure is identical either produced from the observations data or made independently from those.</p>
</blockquote>
<p>But this structure will certainly change in the future, to minimize stored information, keeping only the usefull data for selecting output data (optimizing memory storage, process)</p>
<p>For example, from a list of observation files (useful for evaluation or optimization processes), a named list of data.frame is produced, one for each situation for which the file exists.</p>
<p>Here is an example for a single file for <code>banana</code> observations:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a><span class="co"># remotes::install_github("SticsRPacks/SticsRFiles")</span></span>
<span id="cb3-2"><a href="#cb3-2"></a><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(SticsRFiles)</span>
<span id="cb3-3"><a href="#cb3-3"></a>path &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/system.file">system.file</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/file.path">file.path</a></span>(<span class="st">"extdata"</span>,<span class="st">"obs"</span>,<span class="st">"V9.0"</span>), <span class="dt">package =</span> <span class="st">"SticsRFiles"</span>)</span>
<span id="cb3-4"><a href="#cb3-4"></a>obs_list &lt;-<span class="st"> </span><span class="kw">read_obs</span>(path)</span>
<span id="cb3-5"><a href="#cb3-5"></a><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/lapply">lapply</a></span>(obs_list, <span class="cf">function</span>(x) <span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/head">head</a></span>(x,<span class="dv">4</span>))</span></code></pre></div>
<p>One can give a similar filter list structure defining a customized selection of variables and Dates, but with all values set to NA in data.frames.</p>
</div>
<div id="actions-to-be-performed-by-the-model-wrapper" class="section level3">
<h3 class="hasAnchor">
<a href="#actions-to-be-performed-by-the-model-wrapper" class="anchor"></a>Actions to be performed by the model wrapper</h3>
<div id="before-the-loop-over-situations-list" class="section level4">
<h4 class="hasAnchor">
<a href="#before-the-loop-over-situations-list" class="anchor"></a>Before the loop over situations list</h4>
<ul>
<li>Managing options: checks about its content, reacting from values stored in it<br><strong>For example</strong>:
<ul>
<li>checking if paths exist</li>
<li>checking the model executable, its version, …(libraries availability, …)</li>
<li>storing fields contents in simple variables (easier to use)</li>
<li>other kinds of checks or calculations (depending on the model specificities)</li>
</ul>
</li>
</ul>
</div>
<div id="inside-the-loop-over-situations-list" class="section level4">
<h4 class="hasAnchor">
<a href="#inside-the-loop-over-situations-list" class="anchor"></a>Inside the loop over situations list</h4>
<ol style="list-style-type: decimal">
<li>Managing parameters forcing</li>
</ol>
<p>From the <code>param_values</code> argument, use a mechanism to force values in the model inputs:</p>
<ul>
<li>replacing values in original parameters file(s)</li>
<li>specific file dedicated to force parameters (exists in Stics)</li>
<li>passing parameters values through an interface function to the model (for example R -&gt; cpp, fortran,… libraries)</li>
<li>…</li>
</ul>
<p>The parameters values may be associated with data (<code>prior_information</code>) describing which values for which parameters must be applied to each situation extracted from the parameters values vector <code>param_values</code>.</p>
<p>If <code>prior_information</code> contains the default value (NULL) the same set of parameter values is used for each situation.</p>
<ul>
<li>Example of information stored in <code>prior_information</code> and use:</li>
</ul>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(CroptimizR)</span>
<span id="cb4-2"><a href="#cb4-2"></a>sg=<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">p1=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">sit_list=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"sit1"</span>,<span class="st">"sit2"</span>,<span class="st">"sit3"</span>),<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"sit4"</span>,<span class="st">"sit5"</span>,<span class="st">"sit6"</span>))),</span>
<span id="cb4-3"><a href="#cb4-3"></a>        <span class="dt">p2=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">sit_list=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"sit1"</span>,<span class="st">"sit2"</span>,<span class="st">"sit3"</span>,<span class="st">"sit4"</span>,<span class="st">"sit5"</span>,<span class="st">"sit6"</span>))))</span>
<span id="cb4-4"><a href="#cb4-4"></a></span>
<span id="cb4-5"><a href="#cb4-5"></a>vec=<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>)</span>
<span id="cb4-6"><a href="#cb4-6"></a></span>
<span id="cb4-7"><a href="#cb4-7"></a><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/names">names</a></span>(vec) &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"p2"</span>,<span class="st">"p1"</span>,<span class="st">"p1"</span>)</span>
<span id="cb4-8"><a href="#cb4-8"></a></span>
<span id="cb4-9"><a href="#cb4-9"></a>params_sit2 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/get_params_per_sit.html">get_params_per_sit</a></span>(sg,<span class="st">"sit2"</span>,vec)</span>
<span id="cb4-10"><a href="#cb4-10"></a></span>
<span id="cb4-11"><a href="#cb4-11"></a>params_sit2</span></code></pre></div>
<ol start="2" style="list-style-type: decimal">
<li>Running the model</li>
</ol>
<p>Using a model interface function with a system call or other mechanisms to perform a model run for a situation and get back execution error status.</p>
<ol start="3" style="list-style-type: decimal">
<li>Getting output data</li>
</ol>
<p>If the model run produces files, a function is used to read and format the date/variables outputs. Otherwise the results may be produced directly by an R model function and are to be formatted as expected too.</p>
<ol start="4" style="list-style-type: decimal">
<li>Selecting output data If the optional argument <code>site_var_dates_mask</code> is used to filter data in outputs situations tables, a subset based on rows dates values for columns names (i.e. variables) of site_var_dates_mask is used for each situation.</li>
</ol>
</div>
<div id="managing-optional-parallel-computations-inside-the-loop" class="section level4">
<h4 class="hasAnchor">
<a href="#managing-optional-parallel-computations-inside-the-loop" class="anchor"></a>Managing optional parallel computations inside the loop</h4>
<p>The doParallel package is used and there are specificities when doing a parallel loop especially that a pre allocated list outide of the loop is not shared between cores so return statements must be used inside.</p>
<p>Here is an example for illustrating what happens:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a><span class="co"># Code of an example of foreach loop algo</span></span>
<span id="cb5-2"><a href="#cb5-2"></a><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(<span class="st">"doParallel"</span>)</span>
<span id="cb5-3"><a href="#cb5-3"></a><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(params<span class="op">$</span>cores_nb)</span>
<span id="cb5-4"><a href="#cb5-4"></a></span>
<span id="cb5-5"><a href="#cb5-5"></a>test_parallel &lt;-<span class="st"> </span><span class="cf">function</span>(<span class="dt">cores_nb =</span> <span class="dv">1</span>,</span>
<span id="cb5-6"><a href="#cb5-6"></a>                          <span class="dt">pa =</span> <span class="ot">FALSE</span>,</span>
<span id="cb5-7"><a href="#cb5-7"></a>                          <span class="dt">max_it =</span> <span class="dv">5</span>) {</span>
<span id="cb5-8"><a href="#cb5-8"></a>  </span>
<span id="cb5-9"><a href="#cb5-9"></a>  <span class="co"># Launching the cluster</span></span>
<span id="cb5-10"><a href="#cb5-10"></a>  cl &lt;-<span class="st"> </span><span class="kw">makeCluster</span>(cores_nb)</span>
<span id="cb5-11"><a href="#cb5-11"></a>  <span class="kw">registerDoParallel</span>(cl)</span>
<span id="cb5-12"><a href="#cb5-12"></a>  </span>
<span id="cb5-13"><a href="#cb5-13"></a>  <span class="co"># List preallocation</span></span>
<span id="cb5-14"><a href="#cb5-14"></a>  out_pa &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/vector">vector</a></span>(<span class="dt">mode =</span> <span class="st">"list"</span>, max_it)</span>
<span id="cb5-15"><a href="#cb5-15"></a>  </span>
<span id="cb5-16"><a href="#cb5-16"></a>  <span class="co"># Parallel loop</span></span>
<span id="cb5-17"><a href="#cb5-17"></a>  out &lt;-<span class="st"> </span><span class="kw">foreach</span>(<span class="dt">i =</span> <span class="dv">1</span><span class="op">:</span>max_it) <span class="op">%dopar%</span><span class="st"> </span>{</span>
<span id="cb5-18"><a href="#cb5-18"></a>    <span class="cf">if</span> (pa) {</span>
<span id="cb5-19"><a href="#cb5-19"></a>      out_pa[[i]] &lt;-<span class="st"> </span>i</span>
<span id="cb5-20"><a href="#cb5-20"></a>    } <span class="cf">else</span> {</span>
<span id="cb5-21"><a href="#cb5-21"></a>      <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/function">return</a></span>(i)</span>
<span id="cb5-22"><a href="#cb5-22"></a>    }</span>
<span id="cb5-23"><a href="#cb5-23"></a>  }</span>
<span id="cb5-24"><a href="#cb5-24"></a>  </span>
<span id="cb5-25"><a href="#cb5-25"></a>  <span class="co"># Stopping the cluster</span></span>
<span id="cb5-26"><a href="#cb5-26"></a>  <span class="kw">stopCluster</span>(cl)</span>
<span id="cb5-27"><a href="#cb5-27"></a>  </span>
<span id="cb5-28"><a href="#cb5-28"></a>  <span class="cf">if</span> (pa) {</span>
<span id="cb5-29"><a href="#cb5-29"></a>    <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/function">return</a></span>(out_pa)</span>
<span id="cb5-30"><a href="#cb5-30"></a>  } <span class="cf">else</span> {</span>
<span id="cb5-31"><a href="#cb5-31"></a>    <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/function">return</a></span>(out)</span>
<span id="cb5-32"><a href="#cb5-32"></a>  }</span>
<span id="cb5-33"><a href="#cb5-33"></a>  </span>
<span id="cb5-34"><a href="#cb5-34"></a>  </span>
<span id="cb5-35"><a href="#cb5-35"></a>}</span>
<span id="cb5-36"><a href="#cb5-36"></a></span>
<span id="cb5-37"><a href="#cb5-37"></a>out &lt;-<span class="st"> </span><span class="kw">test_parallel</span>(params<span class="op">$</span>cores_nb)</span>
<span id="cb5-38"><a href="#cb5-38"></a></span>
<span id="cb5-39"><a href="#cb5-39"></a>out_pa &lt;-<span class="st"> </span><span class="kw">test_parallel</span>(params<span class="op">$</span>cores_nb, <span class="ot">TRUE</span>)</span>
<span id="cb5-40"><a href="#cb5-40"></a></span>
<span id="cb5-41"><a href="#cb5-41"></a>out</span>
<span id="cb5-42"><a href="#cb5-42"></a></span>
<span id="cb5-43"><a href="#cb5-43"></a>out_pa</span></code></pre></div>
<p>There are also differences with managing warnings and displays in a parallel context. They must be stored in the return list and treated after the loop.</p>
</div>
<div id="returning-data-for-all-situations" class="section level4">
<h4 class="hasAnchor">
<a href="#returning-data-for-all-situations" class="anchor"></a>Returning data for all situations</h4>
<blockquote>
<p>temporary structure: named list of data.frames, and simulation status flag.</p>
</blockquote>
<p>The wrapper return a list/collection of situation simulations outputs (filtered or not), for the successful simulations. There is also a simulation status return indicating if all simulations ran successfully or not.</p>
</div>
</div>
</div>
<div id="examples-of-use-of-model-wrapper" class="section level2">
<h2 class="hasAnchor">
<a href="#examples-of-use-of-model-wrapper" class="anchor"></a>Examples of use of model wrapper</h2>
<p>TODO</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#introduction">Introduction</a></li>
      <li><a href="#definition">Definition</a></li>
      <li><a href="#writing-the-model-wrapper">Writing the model wrapper</a></li>
      <li><a href="#examples-of-use-of-model-wrapper">Examples of use of model wrapper</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Samuel Buis, Michel Giner, Patrice Lecharpentier, SticsRpacks.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.</p>
</div>
      </footer>
</div>

  

  </body>
</html>
