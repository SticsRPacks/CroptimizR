<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Parameter estimation with the Stics crop Model: a simple case • CroptimizR</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Parameter estimation with the Stics crop Model: a simple case">
<meta property="og:description" content="">
<meta property="og:image" content="/logo.png">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">CroptimizR</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.0.9001</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>

  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/ApsimX_parameter_estimation_simple_case.html">Parameter estimation with the ApsimX crop Model: a simple case</a>
    </li>
    <li>
      <a href="../articles/Designing_a_model_wrapper.html">Elements for implementing a crop model R wrapper</a>
    </li>
    <li>
      <a href="../articles/Parameter_estimation_Specific_and_Varietal.html">Parameter estimation with the Stics crop Model: a case with specific and varietal parameters</a>
    </li>
    <li>
      <a href="../articles/Parameter_estimation_simple_case.html">Parameter estimation with the Stics crop Model: a simple case</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/SticsRPacks/CroptimizR">
    <span class="fab fa fab fa-github fa-lg"></span>

  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Parameter estimation with the Stics crop Model: a simple case</h1>
                        <h4 class="author">Samuel Buis</h4>

            <h4 class="date">2019-12-20</h4>

      <small class="dont-index">Source: <a href="https://github.com/SticsRPacks/CroptimizR/blob/master/vignettes/Parameter_estimation_simple_case.Rmd"><code>vignettes/Parameter_estimation_simple_case.Rmd</code></a></small>
      <div class="hidden name"><code>Parameter_estimation_simple_case.Rmd</code></div>

    </div>



<div id="study-case" class="section level2">
<h2 class="hasAnchor">
<a href="#study-case" class="anchor"></a>Study Case</h2>
<p>This document presents an example of a simple parameter estimation using the stics model with a single situation, a single observed variable and 2 estimated parameters, just to illustrate how to use the package.</p>
<p>Data comes from a maize crop experiment (see description in Wallach et al., 2011).</p>
<p>The parameter estimation is performed using the Nelder-Meade simplex method implemented in the nloptr package.</p>
</div>
<div id="initialisation-step" class="section level2">
<h2 class="hasAnchor">
<a href="#initialisation-step" class="anchor"></a>Initialisation step</h2>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" title="1"><span class="co"># Install and load the needed libraries</span></a>
<a class="sourceLine" id="cb1-2" title="2"><span class="cf">if</span>(<span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html">require</a></span>(<span class="st">"SticsRFiles"</span>)){</a>
<a class="sourceLine" id="cb1-3" title="3">  devtools<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/devtools/man/remote-reexports.html">install_github</a></span>(<span class="st">"SticsRPacks/SticsRFiles@*release"</span>)</a>
<a class="sourceLine" id="cb1-4" title="4">  <span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"SticsRFiles"</span>)</a>
<a class="sourceLine" id="cb1-5" title="5">}</a>
<a class="sourceLine" id="cb1-6" title="6"><span class="cf">if</span>(<span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html">require</a></span>(<span class="st">"SticsOnR"</span>)){</a>
<a class="sourceLine" id="cb1-7" title="7">  devtools<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/devtools/man/remote-reexports.html">install_github</a></span>(<span class="st">"SticsRPacks/SticsOnR@*release"</span>)</a>
<a class="sourceLine" id="cb1-8" title="8">  <span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"SticsOnR"</span>)</a>
<a class="sourceLine" id="cb1-9" title="9">}</a>
<a class="sourceLine" id="cb1-10" title="10"><span class="cf">if</span>(<span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html">require</a></span>(<span class="st">"CroptimizR"</span>)){</a>
<a class="sourceLine" id="cb1-11" title="11">  devtools<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/devtools/man/remote-reexports.html">install_github</a></span>(<span class="st">"SticsRPacks/CroptimizR@*release"</span>)</a>
<a class="sourceLine" id="cb1-12" title="12">  <span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"CroptimizR"</span>)</a>
<a class="sourceLine" id="cb1-13" title="13">}</a>
<a class="sourceLine" id="cb1-14" title="14"></a>
<a class="sourceLine" id="cb1-15" title="15"><span class="co"># Download the example USMs:</span></a>
<a class="sourceLine" id="cb1-16" title="16">data_dir=<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/normalizePath.html">normalizePath</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/tempfile.html">tempdir</a></span>(), <span class="dt">winslash =</span> <span class="st">"/"</span>, <span class="dt">mustWork =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb1-17" title="17">data_dir_zip=<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/normalizePath.html">normalizePath</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(data_dir,<span class="st">"master.zip"</span>), <span class="dt">winslash =</span> <span class="st">"/"</span>, <span class="dt">mustWork =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb1-18" title="18"><span class="kw"><a href="https://rdrr.io/r/utils/download.file.html">download.file</a></span>(<span class="st">"https://github.com/SticsRPacks/data/archive/master.zip"</span>, data_dir_zip)</a>
<a class="sourceLine" id="cb1-19" title="19"><span class="kw"><a href="https://rdrr.io/r/utils/unzip.html">unzip</a></span>(data_dir_zip, <span class="dt">exdir =</span> data_dir)</a>
<a class="sourceLine" id="cb1-20" title="20"><span class="kw"><a href="https://rdrr.io/r/base/unlink.html">unlink</a></span>(data_dir_zip)</a>
<a class="sourceLine" id="cb1-21" title="21">data_dir=<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/normalizePath.html">normalizePath</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/list.files.html">list.dirs</a></span>(data_dir)[<span class="dv">2</span>], <span class="dt">winslash =</span> <span class="st">"/"</span>),<span class="st">"study_case_1"</span>,<span class="st">"V9.0"</span>)</a>
<a class="sourceLine" id="cb1-22" title="22"><span class="co"># NB: all examples are now in data_dir</span></a>
<a class="sourceLine" id="cb1-23" title="23"></a>
<a class="sourceLine" id="cb1-24" title="24"><span class="co"># Define the path to the local version of JavaStics </span></a>
<a class="sourceLine" id="cb1-25" title="25">javastics_path=<span class="kw"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/getwd.html">getwd</a></span>(),<span class="st">"JavaSTICS-1.41-stics-9.0"</span>)</a>
<a class="sourceLine" id="cb1-26" title="26">stics_path=<span class="kw"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(javastics_path,<span class="st">"bin/stics_modulo.exe"</span>)</a></code></pre></div>
</div>
<div id="generate-stics-input-files-from-javastics-input-files" class="section level2">
<h2 class="hasAnchor">
<a href="#generate-stics-input-files-from-javastics-input-files" class="anchor"></a>Generate Stics input files from JavaStics input files</h2>
<p>The Stics wrapper function used in CroptimizR works on text formatted input files (new_travail.usm, climat.txt, …) stored per USMs in different directories. If you start from xml formatted input files (JavaStics format: usms.xml, sols.xml, …) the following lines allow generating txt files from xml files. In this case, xml files are stored in file.path(data_dir,“XmlFiles”).</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" title="1">stics_inputs_path=<span class="kw"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(data_dir,<span class="st">"TxtFiles"</span>)</a>
<a class="sourceLine" id="cb2-2" title="2"><span class="kw"><a href="https://rdrr.io/r/base/files2.html">dir.create</a></span>(stics_inputs_path)</a>
<a class="sourceLine" id="cb2-3" title="3"></a>
<a class="sourceLine" id="cb2-4" title="4"><span class="kw">gen_usms_dirs</span>(<span class="dt">javastics_path =</span> javastics_path, <span class="dt">javastics_workspace_path =</span> <span class="kw"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(data_dir,<span class="st">"XmlFiles"</span>),</a>
<a class="sourceLine" id="cb2-5" title="5">  <span class="dt">target_path =</span> stics_inputs_path, <span class="dt">display =</span> <span class="ot">TRUE</span>)</a></code></pre></div>
</div>
<div id="run-the-model-before-optimization-for-a-prior-evaluation" class="section level2">
<h2 class="hasAnchor">
<a href="#run-the-model-before-optimization-for-a-prior-evaluation" class="anchor"></a>Run the model before optimization for a prior evaluation</h2>
<p>Here model parameters values are read in the model input files.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" title="1"><span class="co"># Set the model options (see '? stics_wrapper_options' for details)</span></a>
<a class="sourceLine" id="cb3-2" title="2">model_options=<span class="kw"><a href="https://rdrr.io/pkg/SticsOnR/man/stics_wrapper_options.html">stics_wrapper_options</a></span>(stics_path,stics_inputs_path,</a>
<a class="sourceLine" id="cb3-3" title="3">                                    <span class="dt">parallel=</span><span class="ot">FALSE</span>) </a>
<a class="sourceLine" id="cb3-4" title="4"></a>
<a class="sourceLine" id="cb3-5" title="5"><span class="co"># Run the model on all situations found in stics_inputs_path</span></a>
<a class="sourceLine" id="cb3-6" title="6">sim_before_optim=<span class="kw"><a href="https://rdrr.io/pkg/SticsOnR/man/stics_wrapper.html">stics_wrapper</a></span>(<span class="dt">model_options=</span>model_options)</a></code></pre></div>
</div>
<div id="read-and-select-the-observations-for-the-parameter-estimation" class="section level2">
<h2 class="hasAnchor">
<a href="#read-and-select-the-observations-for-the-parameter-estimation" class="anchor"></a>Read and select the observations for the parameter estimation</h2>
<p>We only keep observations for situation (i.e. USM for Stics) sit_name and variable var_name (obs_list variable defines the list of situations and variables that will be used in the parameter estimation process).</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" title="1">sit_name=<span class="st">"bo96iN+"</span>  <span class="co">## among bo96iN+, bou00t1, bou00t3, bou99t1, bou99t3,</span></a>
<a class="sourceLine" id="cb4-2" title="2">                    <span class="co">## lu96iN+, lu96iN6 or lu97iN+</span></a>
<a class="sourceLine" id="cb4-3" title="3"></a>
<a class="sourceLine" id="cb4-4" title="4"><span class="co"># For the moment read_obs_to_list is only able to read obs files in one folder ...</span></a>
<a class="sourceLine" id="cb4-5" title="5"><span class="co"># this will change in future release of sticsRfiles</span></a>
<a class="sourceLine" id="cb4-6" title="6">obs_list=<span class="kw"><a href="https://rdrr.io/pkg/SticsRFiles/man/read_obs_to_list.html">read_obs_to_list</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(data_dir,<span class="st">"XmlFiles"</span>), </a>
<a class="sourceLine" id="cb4-7" title="7">                          <span class="dt">obs_filenames =</span> <span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(sit_name,<span class="st">".obs"</span>))</a>
<a class="sourceLine" id="cb4-8" title="8"></a>
<a class="sourceLine" id="cb4-9" title="9">var_name=<span class="st">"lai_n"</span>    <span class="co">## lai_n or masec_n</span></a>
<a class="sourceLine" id="cb4-10" title="10">obs_list[[sit_name]]=obs_list[[sit_name]][,<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"Date"</span>,var_name)]</a></code></pre></div>
</div>
<div id="set-prior-information-on-the-parameters-to-estimate" class="section level2">
<h2 class="hasAnchor">
<a href="#set-prior-information-on-the-parameters-to-estimate" class="anchor"></a>Set prior information on the parameters to estimate</h2>
<p>prior_information determines the list of parameters that will be estimated in the parameter estimation process and associated prior information (only uniform distributions for the moment, others will come soon).</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" title="1"><span class="co"># 2 parameters here: dlaimax and durvieF, of prior distributions U([0.0005,0.0025]) and U([50,400])</span></a>
<a class="sourceLine" id="cb5-2" title="2">prior_information=<span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">lb=</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dt">dlaimax=</span><span class="fl">0.0005</span>, <span class="dt">durvieF=</span><span class="dv">50</span>),</a>
<a class="sourceLine" id="cb5-3" title="3">                       <span class="dt">ub=</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dt">dlaimax=</span><span class="fl">0.0025</span>, <span class="dt">durvieF=</span><span class="dv">400</span>))</a></code></pre></div>
</div>
<div id="set-options-for-the-parameter-estimation-method" class="section level2">
<h2 class="hasAnchor">
<a href="#set-options-for-the-parameter-estimation-method" class="anchor"></a>Set options for the parameter estimation method</h2>
<p>optim_options should contain the options of the parameter estimation method. Here we defined a few options for the simplex method of the nloptr package (default method in estim_param). The full set of options for the simplex method can be found in the <a href="https://cran.r-project.org/web/packages/nloptr/vignettes/nloptr.pdf">vignette of nloptr package</a>.</p>
<p>The number of repetitions is advised to be set to at least 5, while 10 is a reasonable maximum value. maxeval should be used to stop the minimization only if results have to be produced within a given duration, otherwise set it to a high value so that the minimization stops when the criterion based on xtol_rel is satisfied.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" title="1">optim_options=<span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>() </a>
<a class="sourceLine" id="cb6-2" title="2">optim_options<span class="op">$</span>nb_rep &lt;-<span class="st"> </span><span class="dv">1</span> <span class="co">#7 # Number of repetitions of the minimization </span></a>
<a class="sourceLine" id="cb6-3" title="3">                          <span class="co"># (each time starting with different initial</span></a>
<a class="sourceLine" id="cb6-4" title="4">                          <span class="co"># values for the estimated parameters) </span></a>
<a class="sourceLine" id="cb6-5" title="5">optim_options<span class="op">$</span>maxeval &lt;-<span class="st"> </span><span class="dv">1</span> <span class="co">#500 # Maximum number of evaluations of the </span></a>
<a class="sourceLine" id="cb6-6" title="6">                             <span class="co"># minimized criteria </span></a>
<a class="sourceLine" id="cb6-7" title="7">optim_options<span class="op">$</span>xtol_rel &lt;-<span class="st"> </span><span class="fl">1e-03</span> <span class="co"># Tolerance criterion between two iterations</span></a>
<a class="sourceLine" id="cb6-8" title="8">                                <span class="co"># (threshold for the relative difference of</span></a>
<a class="sourceLine" id="cb6-9" title="9">                                <span class="co"># parameter values between the 2 previous </span></a>
<a class="sourceLine" id="cb6-10" title="10">                                <span class="co"># iterations)</span></a>
<a class="sourceLine" id="cb6-11" title="11">optim_options<span class="op">$</span>path_results &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/getwd.html">getwd</a></span>() <span class="co"># path where to store the results (graph and Rdata)</span></a>
<a class="sourceLine" id="cb6-12" title="12">optim_options<span class="op">$</span>ranseed &lt;-<span class="st"> </span><span class="dv">1234</span> <span class="co"># set random seed so that each execution give the same results</span></a>
<a class="sourceLine" id="cb6-13" title="13">                              <span class="co"># If you want randomization, don't set it.</span></a></code></pre></div>
</div>
<div id="run-the-optimization" class="section level2">
<h2 class="hasAnchor">
<a href="#run-the-optimization" class="anchor"></a>Run the optimization</h2>
<p>The Nelder-Meade simplex is the default method =&gt; no need to set the optim_method argument. For the moment it is the only method interfaced (others will come soonly). Same for crit_function: a value is set by default (crit_cwss, see wallach et al., 2011). For the moment only 2 criterion are proposed (crit_log_cwss and crit_cwss), others will be proposed in next versions of CroptimizR. The user can implement its own criterion (see inputs and outputs required in the crit_cwss function).</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" title="1">optim_results=<span class="kw"><a href="../reference/estim_param.html">estim_param</a></span>(<span class="dt">obs_list=</span>obs_list,</a>
<a class="sourceLine" id="cb7-2" title="2">                            <span class="dt">model_function=</span>stics_wrapper,</a>
<a class="sourceLine" id="cb7-3" title="3">                            <span class="dt">model_options=</span>model_options,</a>
<a class="sourceLine" id="cb7-4" title="4">                            <span class="dt">optim_options=</span>optim_options,</a>
<a class="sourceLine" id="cb7-5" title="5">                            <span class="dt">prior_information=</span>prior_information)</a></code></pre></div>
<p>The results printed in output on the R console are the following:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" title="1"><span class="co">## [1] "Estimated value for dlaimax :  0.00169614928696274"</span></a>
<a class="sourceLine" id="cb8-2" title="2"><span class="co">## [1] "Estimated value for durvieF :  53.9691276907021"</span></a>
<a class="sourceLine" id="cb8-3" title="3"><span class="co">## [1] "Minimum value of the criterion : 112.530331140718"</span></a></code></pre></div>
<p>Complementary graphs and data are stored in the optim_options$path_results folder. Among them, the EstimatedVSinit.pdf file containing the following figures:</p>
<p><img src="ResultsSimpleCase/estimInit_dlaimax.PNG" width="50%"><img src="ResultsSimpleCase/estimInit_durvieF.PNG" width="50%"></p>
<p>Figure 1: plots of estimated vs initial values of parameters dlaimax and durvieF. Numbers represent the repetition number of the minimization. The number in red, 2 in this case, is the minimization that lead to the minimal value of the criterion among all repetitions. In this case, the minimizations converge towards 2 different values for the parameters, which indicates the presence of a local minimum. Values of durvieF are close to the bounds. In realistic calibration cases with many observed situations / variables / dates this may indicate the presence of biases in the observation values or in the model output values simulated (this simple case with only one situation does not allow to derive such conclusion).</p>
<p>The optim_options$path_results folder also contains the optim_results.Rdata file that store the nlo variable, a list containing the results of the minimization for each repetition. If we print it for repetition 2 …</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" title="1"><span class="kw"><a href="https://rdrr.io/r/base/load.html">load</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(optim_options<span class="op">$</span>path_results,<span class="st">"optim_results.Rdata"</span>))</a>
<a class="sourceLine" id="cb9-2" title="2">nlo[[<span class="dv">2</span>]]</a></code></pre></div>
<p>… this returns:</p>
<pre><code>## Warning: l'espace de nom 'SticsOptimizR' n'est pas disponible et a été remplacé
## par .GlobalEnv lors du traitement de l'objet 'nlo'</code></pre>
<pre><code>##
## Call:
## nloptr(x0 = init_values[irep, ], eval_f = main_crit, lb = bounds$lb,
##     ub = bounds$ub, opts = list(algorithm = "NLOPT_LN_NELDERMEAD",
##         xtol_rel = xtol_rel, maxeval = maxeval, ranseed = ranseed),
##     crit_options = crit_options_loc)
##
##
## Minimization using NLopt version 2.4.2
##
## NLopt solver status: 4 ( NLOPT_XTOL_REACHED: Optimization stopped because
## xtol_rel or xtol_abs (above) was reached. )
##
## Number of Iterations....: 44
## Termination conditions:  xtol_rel: 0.001 maxeval: 500
## Number of inequality constraints:  0
## Number of equality constraints:    0
## Optimal value of objective function:  112.530331140718
## Optimal value of controls: 0.001696149 53.96913</code></pre>
</div>
<div id="run-the-model-after-optimization" class="section level2">
<h2 class="hasAnchor">
<a href="#run-the-model-after-optimization" class="anchor"></a>Run the model after optimization</h2>
<p>We run here the Stics model using the estimated values of the parameters. In this case, the param_values argument of the stics_wrapper function is thus set so that estimated values of the parameters overwrite the values defined in the model input files.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" title="1">sim_after_optim=<span class="kw"><a href="https://rdrr.io/pkg/SticsOnR/man/stics_wrapper.html">stics_wrapper</a></span>(<span class="dt">param_values=</span>optim_results<span class="op">$</span>final_values,</a>
<a class="sourceLine" id="cb12-2" title="2">                              <span class="dt">model_options=</span>model_options)</a></code></pre></div>
</div>
<div id="plot-the-results" class="section level2">
<h2 class="hasAnchor">
<a href="#plot-the-results" class="anchor"></a>Plot the results</h2>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" title="1"><span class="kw"><a href="https://rdrr.io/r/grDevices/png.html">png</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(optim_options<span class="op">$</span>path_results,<span class="st">"sim_obs_plots.png"</span>),</a>
<a class="sourceLine" id="cb13-2" title="2">    <span class="dt">width =</span> <span class="dv">15</span>, <span class="dt">height =</span> <span class="dv">10</span>, <span class="dt">units =</span> <span class="st">"cm"</span>, <span class="dt">res=</span><span class="dv">1000</span>)</a>
<a class="sourceLine" id="cb13-3" title="3"><span class="kw"><a href="https://rdrr.io/r/graphics/par.html">par</a></span>(<span class="dt">mfrow =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">1</span>,<span class="dv">2</span>))</a>
<a class="sourceLine" id="cb13-4" title="4"></a>
<a class="sourceLine" id="cb13-5" title="5"><span class="co"># Simulated and observed LAI before optimization</span></a>
<a class="sourceLine" id="cb13-6" title="6">Ymax=<span class="kw"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(obs_list[[sit_name]][,var_name], <span class="dt">na.rm=</span><span class="ot">TRUE</span>),</a>
<a class="sourceLine" id="cb13-7" title="7">         <span class="kw"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(sim_before_optim<span class="op">$</span>sim_list[[sit_name]][,var_name], <span class="dt">na.rm=</span><span class="ot">TRUE</span>))</a>
<a class="sourceLine" id="cb13-8" title="8"><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(sim_before_optim<span class="op">$</span>sim_list[[sit_name]][,<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"Date"</span>,var_name)],<span class="dt">type=</span><span class="st">"l"</span>,</a>
<a class="sourceLine" id="cb13-9" title="9">     <span class="dt">main=</span><span class="st">"Before optimization"</span>,<span class="dt">ylim=</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">0</span>,Ymax<span class="op">+</span>Ymax<span class="op">*</span><span class="fl">0.1</span>))</a>
<a class="sourceLine" id="cb13-10" title="10"><span class="kw"><a href="https://rdrr.io/r/graphics/points.html">points</a></span>(obs_list[[sit_name]],<span class="dt">col=</span><span class="st">"green"</span>)</a>
<a class="sourceLine" id="cb13-11" title="11"></a>
<a class="sourceLine" id="cb13-12" title="12"><span class="co"># Simulated and observed LAI after optimization</span></a>
<a class="sourceLine" id="cb13-13" title="13"><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(sim_after_optim<span class="op">$</span>sim_list[[sit_name]][,<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"Date"</span>,var_name)],<span class="dt">type=</span><span class="st">"l"</span>,</a>
<a class="sourceLine" id="cb13-14" title="14">     <span class="dt">main=</span><span class="st">"After optimization"</span>,<span class="dt">ylim=</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">0</span>,Ymax<span class="op">+</span>Ymax<span class="op">*</span><span class="fl">0.1</span>))</a>
<a class="sourceLine" id="cb13-15" title="15"><span class="kw"><a href="https://rdrr.io/r/graphics/points.html">points</a></span>(obs_list[[sit_name]],<span class="dt">col=</span><span class="st">"green"</span>)</a>
<a class="sourceLine" id="cb13-16" title="16"></a>
<a class="sourceLine" id="cb13-17" title="17"><span class="kw"><a href="https://rdrr.io/r/grDevices/dev.html">dev.off</a></span>()</a></code></pre></div>
<p>This gives:</p>
<div class="figure">
<img src="ResultsSimpleCase/sim_obs_plots.png" alt="Figure 2: plots of simulated and observed target variable before and after optimization. The gap between simulated and observed values has been drastically reduced: the minimizer has done its job!" width="80%"><p class="caption">
Figure 2: plots of simulated and observed target variable before and after optimization. The gap between simulated and observed values has been drastically reduced: the minimizer has done its job!
</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#study-case">Study Case</a></li>
      <li><a href="#initialisation-step">Initialisation step</a></li>
      <li><a href="#generate-stics-input-files-from-javastics-input-files">Generate Stics input files from JavaStics input files</a></li>
      <li><a href="#run-the-model-before-optimization-for-a-prior-evaluation">Run the model before optimization for a prior evaluation</a></li>
      <li><a href="#read-and-select-the-observations-for-the-parameter-estimation">Read and select the observations for the parameter estimation</a></li>
      <li><a href="#set-prior-information-on-the-parameters-to-estimate">Set prior information on the parameters to estimate</a></li>
      <li><a href="#set-options-for-the-parameter-estimation-method">Set options for the parameter estimation method</a></li>
      <li><a href="#run-the-optimization">Run the optimization</a></li>
      <li><a href="#run-the-model-after-optimization">Run the model after optimization</a></li>
      <li><a href="#plot-the-results">Plot the results</a></li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Samuel Buis, Michel Giner, Patrice Lecharpentier, SticsRpacks.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.</p>
</div>

      </footer>
</div>




  </body>
</html>
