<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Guidelines for implementing a crop model R wrapper for CroptimizR • CroptimizR</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Guidelines for implementing a crop model R wrapper for CroptimizR">
<meta property="og:description" content="CroptimizR">
<meta property="og:image" content="/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">CroptimizR</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.4.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/ApsimX_parameter_estimation_simple_case.html">Parameter estimation with the ApsimX crop Model: a simple case</a>
    </li>
    <li>
      <a href="../articles/Available_parameter_estimation_algorithms.html">Available parameter estimation algorithms in CroptimizR</a>
    </li>
    <li>
      <a href="../articles/Designing_a_model_wrapper.html">Guidelines for implementing a crop model R wrapper for CroptimizR</a>
    </li>
    <li>
      <a href="../articles/Parameter_estimation_DREAM.html">Parameter estimation with the DREAM-zs algorithm</a>
    </li>
    <li>
      <a href="../articles/Parameter_estimation_Specific_and_Varietal.html">Parameter estimation with the Stics crop Model: a case with specific and varietal parameters</a>
    </li>
    <li>
      <a href="../articles/Parameter_estimation_simple_case.html">Parameter estimation with the Stics crop Model: a simple case</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/SticsRPacks/CroptimizR/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="Designing_a_model_wrapper_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Guidelines for implementing a crop model R wrapper for CroptimizR</h1>
                        <h4 class="author">Samuel Buis</h4>
            <address class="author_afil">
      INRAE - EMMAH<br><h4 class="author">Patrice Lecharpentier</h4>
            <address class="author_afil">
      INRAE - Agroclim<br><h4 class="date">2021-07-22</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/SticsRPacks/CroptimizR/blob/master/vignettes/Designing_a_model_wrapper.Rmd"><code>vignettes/Designing_a_model_wrapper.Rmd</code></a></small>
      <div class="hidden name"><code>Designing_a_model_wrapper.Rmd</code></div>

    </address>
</address>
</div>

    
    
<div id="introduction" class="section level2">
<h2 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h2>
<p>R wrappers are necessary to couple crop models with CroptimizR. Indeed, the <code>estim_param</code> function will need to run the model (for which parameters have to be estimated), on a set of observed situations and for values of estimated parameters proposed by the selected algorithm. It will then compute the selected (least-square or likelihood) criterion using the resulting simulated values and corresponding observations. An R wrapper is thus basically an R function able to run model simulations for prescribed values of some of its input parameters and to return the values of its simulated outputs. It must have specific arguments, returned values and behavior, as detailed in the following.</p>
<p>The first section presents the concepts for building a basic version of a model wrapper. The second section section presents optional issues. The third one shows examples on a simple toy model.</p>
</div>
<div id="how-to-write-a-basic-version-of-a-model-wrapper-for-croptimizr" class="section level2">
<h2 class="hasAnchor">
<a href="#how-to-write-a-basic-version-of-a-model-wrapper-for-croptimizr" class="anchor"></a>How to write a basic version of a model wrapper for CroptimizR</h2>
<p>We will detail here what is mandatory in terms of interface of the wrapper and expected behavior. Optional issues for more advanced users are detailed in the next section.</p>
<p><strong>Please note that this basic version does not allow to perform simultaneous estimation of specific and varietal parameters on a dataset including several cultivars (i.e. as in the example detailed in <a href="https://sticsrpacks.github.io/CroptimizR/articles/Parameter_estimation_Specific_and_Varietal.html" class="uri">https://sticsrpacks.github.io/CroptimizR/articles/Parameter_estimation_Specific_and_Varietal.html</a>). Additional functionnalities are needed for that, as detailed in section “Optional issues”.</strong></p>
<div id="model-wrapper-interface" class="section level3">
<h3 class="hasAnchor">
<a href="#model-wrapper-interface" class="anchor"></a>Model wrapper interface</h3>
<p>Here’s a header for a basic version of a model wrapper:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#' @title My model wrapper for CroptimizR</span>
<span class="co">#'</span>
<span class="co">#' @description This function runs my crop model on a set of situations (i.e. environments) </span>
<span class="co">#' using the values of the parameters defined in the param_values argument. It returns </span>
<span class="co">#' the values of the simulated outputs.</span>
<span class="co">#'</span>
<span class="co">#' @param param_values (optional) a named vector that contains the value(s) and name(s) </span>
<span class="co">#' of the parameters to force for each situation to simulate. If not provided (or if is </span>
<span class="co">#' NULL), the simulations will be performed using default values of the parameters </span>
<span class="co">#' (e.g. as read in the model input files).</span>
<span class="co">#'</span>
<span class="co">#' @param sit_names Vector of situations names for which results must be returned. </span>
<span class="co">#'</span>
<span class="co">#' @param model_options List containing any information needed to run the model </span>
<span class="co">#' (e.g. path to model input files and executable, ...) </span>
<span class="co">#'</span>
<span class="co">#' @return A list containing:</span>
<span class="co">#'     o `sim_list`: a `named list` (names = situations names) of data.frames (or tibbles) of </span>
<span class="co">#` simulated output values (one element of the list per simulated situation) </span>
<span class="co">#'     o `error`: an error code indicating if at least one simulation ended with an error.</span>

<span class="va">model_wrapper</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span> <span class="va">param_values</span><span class="op">=</span><span class="cn">NULL</span>, <span class="va">sit_names</span>, <span class="va">model_options</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span>

<span class="op">}</span></code></pre></div>
<p><strong>Each argument detailed here must be defined for any CroptimizR model wrapper. You can use this header to develop yours. Be careful, “…” is mandatory at the end of the argument list since CroptimizR may give additional arguments for more advanced wrappers.</strong></p>
<p>The shape of the <code>param_values</code> and <code>sit_names</code> arguments are imposed by CroptimizR. This is not the case of the <code>model_options</code> argument (except the fact that is must be a list): its content must be defined by the developper of the model wrapper. It is typically used to provide to the model wrapper what it needs to run the model (e.g. path to the model executable, path to the directory containing model input files for the situations to simulate, …). The user provides <code>model_options</code> to <code>estim_param</code> which gives it as is to the model wrapper.</p>
<p>It is advisable to define <code>param_values</code> as an optional argument, so that the model wrapper can be used directly by the user (i.e. outside of <code>estim_param</code>) to run the model using default values for all of its parameters.</p>
</div>
<div id="minimum-required-functionalities" class="section level3">
<h3 class="hasAnchor">
<a href="#minimum-required-functionalities" class="anchor"></a>Minimum required functionalities</h3>
<ul>
<li>
<p>Run the model on a specified set of situations</p>
<p>A situation corresponds to a simulation (for example a specific treatment on a given soil for a given period).</p>
<p>To run your model from R, several technical solutions are possible depending on the language it is implemented with. A simple solution (although not the most computationally efficient) is to run its executable using the R function <code>system2</code>. Otherwise, different languages can be directly interfaced in R: for example Python, using the R package <code>reticulate</code>, C and C++ (see e.g. <a href="https://www.r-bloggers.com/three-ways-to-call-cc-from-r/" class="uri">https://www.r-bloggers.com/three-ways-to-call-cc-from-r/</a>), fortran (see e.g. <a href="https://www.r-bloggers.com/fortran-and-r-speed-things-up/" class="uri">https://www.r-bloggers.com/fortran-and-r-speed-things-up/</a>)…</p>
</li>
<li>
<p>Force the model with specified values of its parameters</p>
<p>The values of the parameters are specified in the <code>param_values</code> vector. The names of the parameters can be retrieved using <code><a href="https://rdrr.io/r/base/names.html">names(param_values)</a></code>.</p>
</li>
<li>
<p>Return the simulated results for all simulated variables</p>
<p>The value returned by the model wrapper must be a list, noted <code>results</code> in the following. This list must contain an element named <code>sim_list</code>. <code>sim_list</code> must be a named list (names = situations names) of size the number of situations to simulate and having the attribute “cropr_simulation” (to use the <a href="https://github.com/SticsRPacks/CroPlotR">CroPlotR package</a>). You can initialize it like this:</p>
<p><code>results$sim_list &lt;- setNames(vector("list",length(sit_names)), nm = sit_names)</code> <code>attr(results$sim_list, "class")= "cropr_simulation"</code></p>
<p>Each element of the list should contains a data.frame (or a tibble) with the results obtained for all simulated variables and dates for the given situation.</p>
<p>The data.frames must have one column called <code>Date</code> containing the simulations dates, in Date or POSIXct format (see R function <code><a href="https://rdrr.io/r/base/as.Date.html">base::as.Date</a></code> or <code><a href="https://rdrr.io/r/base/as.POSIXlt.html">base::as.POSIXct</a></code>). The other columns contains the values of the simulated variables, and their names must be put as column names.</p>
<p>For example, if <code>sit_names</code> is `c(“situation1”,“situation2”,“situation3”), sim_list should look like:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a>sim_list<span class="op">$</span>situation1</span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="co"># A tibble: *** x ***</span></span>
<span id="cb2-3"><a href="#cb2-3"></a>   Date         var1    var2    var3  ...</span>
<span id="cb2-4"><a href="#cb2-4"></a>   <span class="op">&lt;</span>dttm<span class="op">&gt;</span><span class="st">     </span><span class="er">&lt;</span>dbl<span class="op">&gt;</span><span class="st">   </span><span class="er">&lt;</span>dbl<span class="op">&gt;</span><span class="st">   </span><span class="er">&lt;</span>dbl<span class="op">&gt;</span><span class="st"> </span></span>
<span id="cb2-5"><a href="#cb2-5"></a><span class="st"> </span><span class="dv">1</span> <span class="dv">1994-10-17</span>   <span class="dv">0</span>      <span class="fl">2.53</span>    <span class="fl">4.80</span></span>
<span id="cb2-6"><a href="#cb2-6"></a> <span class="dv">2</span> <span class="dv">1994-10-18</span>   <span class="dv">0</span>      <span class="fl">2.31</span>    <span class="fl">4.66</span></span>
<span id="cb2-7"><a href="#cb2-7"></a> <span class="dv">3</span> <span class="dv">1994-10-19</span>   <span class="dv">0</span>      <span class="fl">4.55</span>    <span class="fl">4.44</span></span>
<span id="cb2-8"><a href="#cb2-8"></a></span>
<span id="cb2-9"><a href="#cb2-9"></a></span>
<span id="cb2-10"><a href="#cb2-10"></a>sim_list<span class="op">$</span>situation2</span>
<span id="cb2-11"><a href="#cb2-11"></a><span class="co"># A tibble: *** x ***</span></span>
<span id="cb2-12"><a href="#cb2-12"></a>   Date         var1    var2    var3  ...</span>
<span id="cb2-13"><a href="#cb2-13"></a>   <span class="op">&lt;</span>dttm<span class="op">&gt;</span><span class="st">     </span><span class="er">&lt;</span>dbl<span class="op">&gt;</span><span class="st">   </span><span class="er">&lt;</span>dbl<span class="op">&gt;</span><span class="st">   </span><span class="er">&lt;</span>dbl<span class="op">&gt;</span><span class="st"> </span></span>
<span id="cb2-14"><a href="#cb2-14"></a><span class="st"> </span><span class="dv">1</span> <span class="dv">1995-10-17</span>   <span class="dv">0</span>      <span class="fl">2.60</span>    <span class="fl">4.80</span></span>
<span id="cb2-15"><a href="#cb2-15"></a> <span class="dv">2</span> <span class="dv">1995-10-18</span>   <span class="dv">0</span>      <span class="fl">3.42</span>    <span class="fl">4.70</span></span>
<span id="cb2-16"><a href="#cb2-16"></a> <span class="dv">3</span> <span class="dv">1995-10-19</span>   <span class="dv">0</span>      <span class="fl">5.25</span>    <span class="fl">4.45</span></span>
<span id="cb2-17"><a href="#cb2-17"></a></span>
<span id="cb2-18"><a href="#cb2-18"></a></span>
<span id="cb2-19"><a href="#cb2-19"></a>sim_list<span class="op">$</span>situation3</span>
<span id="cb2-20"><a href="#cb2-20"></a><span class="co"># A tibble: *** x ***</span></span>
<span id="cb2-21"><a href="#cb2-21"></a>   Date         var1    var2    var3  ...</span>
<span id="cb2-22"><a href="#cb2-22"></a>   <span class="op">&lt;</span>dttm<span class="op">&gt;</span><span class="st">     </span><span class="er">&lt;</span>dbl<span class="op">&gt;</span><span class="st">   </span><span class="er">&lt;</span>dbl<span class="op">&gt;</span><span class="st">   </span><span class="er">&lt;</span>dbl<span class="op">&gt;</span><span class="st"> </span></span>
<span id="cb2-23"><a href="#cb2-23"></a><span class="st"> </span><span class="dv">1</span> <span class="dv">1996-10-17</span>   <span class="dv">0</span>      <span class="fl">2.41</span>    <span class="fl">4.81</span></span>
<span id="cb2-24"><a href="#cb2-24"></a> <span class="dv">2</span> <span class="dv">1996-10-18</span>   <span class="dv">0</span>      <span class="fl">3.03</span>    <span class="fl">4.71</span></span>
<span id="cb2-25"><a href="#cb2-25"></a> <span class="dv">3</span> <span class="dv">1996-10-19</span>   <span class="dv">0</span>      <span class="fl">5.10</span>    <span class="fl">4.47</span></span></code></pre></div>
</li>
<li>
<p>Return an error code if any simulation failed</p>
<p>If any simulation failed for any reason, use the R function <code>warning</code> to print any useful information about the error and set the variable <code>results$error</code> to <code>TRUE</code> (and to <code>FALSE</code> otherwise).</p>
</li>
</ul>
</div>
<div id="implementation" class="section level3">
<h3 class="hasAnchor">
<a href="#implementation" class="anchor"></a>Implementation</h3>
<p>A typical pseudo-code implementation of a basic wrapper function is thus:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a>model_wrapper &lt;-<span class="st"> </span><span class="cf">function</span>( <span class="dt">param_values=</span><span class="ot">NULL</span>, sit_names, model_options, ...) {</span>
<span id="cb3-2"><a href="#cb3-2"></a>  </span>
<span id="cb3-3"><a href="#cb3-3"></a>  <span class="co"># Initializations</span></span>
<span id="cb3-4"><a href="#cb3-4"></a>  param_names &lt;-<span class="st"> </span><span class="kw">names</span>(param_values)</span>
<span id="cb3-5"><a href="#cb3-5"></a>  results &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">sim_list =</span> <span class="kw">setNames</span>(<span class="kw">vector</span>(<span class="st">"list"</span>,<span class="kw">length</span>(sit_names)), <span class="dt">nm =</span> sit_names),</span>
<span id="cb3-6"><a href="#cb3-6"></a>                 <span class="dt">error=</span><span class="ot">FALSE</span>)</span>
<span id="cb3-7"><a href="#cb3-7"></a>  <span class="kw">attr</span>(results<span class="op">$</span>sim_list, <span class="st">"class"</span>)=<span class="st"> "cropr_simulation"</span></span>
<span id="cb3-8"><a href="#cb3-8"></a>  </span>
<span id="cb3-9"><a href="#cb3-9"></a>  <span class="cf">for</span> (situation <span class="cf">in</span> sit_names) {</span>
<span id="cb3-10"><a href="#cb3-10"></a>      </span>
<span id="cb3-11"><a href="#cb3-11"></a>      <span class="co"># overwrite model input parameters of names contained in param_names with values </span></span>
<span id="cb3-12"><a href="#cb3-12"></a>      <span class="co"># retrieved in param_values</span></span>
<span id="cb3-13"><a href="#cb3-13"></a>      </span>
<span id="cb3-14"><a href="#cb3-14"></a>      <span class="co"># run the model for the given situation </span></span>
<span id="cb3-15"><a href="#cb3-15"></a>      </span>
<span id="cb3-16"><a href="#cb3-16"></a>      <span class="co"># read the results and store the data.frame in result$sim_list[[situation]]</span></span>
<span id="cb3-17"><a href="#cb3-17"></a>      </span>
<span id="cb3-18"><a href="#cb3-18"></a>      <span class="cf">if</span> (any_error_returned_by_the model_or_detected_in_its_results) {</span>
<span id="cb3-19"><a href="#cb3-19"></a>        <span class="kw">warning</span>(<span class="st">"any_useful_information_to_describe_the_error"</span>)</span>
<span id="cb3-20"><a href="#cb3-20"></a>        results<span class="op">$</span>error=<span class="ot">TRUE</span></span>
<span id="cb3-21"><a href="#cb3-21"></a>      }</span>
<span id="cb3-22"><a href="#cb3-22"></a>      </span>
<span id="cb3-23"><a href="#cb3-23"></a>    }</span>
<span id="cb3-24"><a href="#cb3-24"></a>    </span>
<span id="cb3-25"><a href="#cb3-25"></a>  }</span>
<span id="cb3-26"><a href="#cb3-26"></a>  </span>
<span id="cb3-27"><a href="#cb3-27"></a>  <span class="kw">return</span>(results)</span>
<span id="cb3-28"><a href="#cb3-28"></a>  </span>
<span id="cb3-29"><a href="#cb3-29"></a><span class="er">}</span></span></code></pre></div>
</div>
<div id="test-your-wrapper" class="section level3">
<h3 class="hasAnchor">
<a href="#test-your-wrapper" class="anchor"></a>Test your wrapper</h3>
<ul>
<li><p>Check the results returned by the wrapper are identical to what is given by your model when used in a standard way (i.e. not through the wrapper)</p></li>
<li>
<p>Run the test_wrapper function</p>
<p><code><a href="../reference/test_wrapper.html">test_wrapper(model_function, model_options, param_values, sit_names, var_names=NULL)</a></code></p>
<p>This function has been created to perfom several checks on user model wrappers.</p>
<p>It takes in input:</p>
<ul>
<li>model_function: the crop Model wrapper function to use.</li>
<li>model_options: the list of options of the Crop Model wrapper.</li>
<li>param_values: a named vector that contains values and names for AT LEAST TWO model parameters THAT ARE EXPECTED TO PLAY ON ITS RESULTS (e.g. param_values &lt;- c(P1=10, P2=50))</li>
<li>sit_names: a vector of situations names for which results must be tested.</li>
<li>var_names (optional): a vector of variables names for which results must be tested (if taken into account by the wrapper)</li>
</ul>
<p>It runs the given model wrapper consecutively with different subsets of param_values.</p>
<p>It then checks:</p>
<ul>
<li>the format of the returned results</li>
<li>the results are different when different subsets of param_values are used,</li>
<li>the results are identical when same subsets of param_values are used.</li>
</ul>
<p>If all tests succeed, it returns:</p>
<pre><code>## Test the wrapper returns outputs in expected format ...</code></pre>
<pre><code>## ... OK</code></pre>
<pre><code>## Test the wrapper gives identical results when running with same inputs ...</code></pre>
<pre><code>## ... OK</code></pre>
<pre><code>## Test the wrapper gives different results when running with different inputs ...</code></pre>
<pre><code>## ... OK</code></pre>
<p>If some test fails, information written in red should help you understanding the problem.</p>
<p>Examples of use of this function are given in section <strong>Examples</strong></p>
</li>
<li><p>Try to play with the <code>estim_param</code> function on your wrapper for a simple case (see e.g. examples in section <strong>Examples</strong> or <a href="https://sticsrpacks.github.io/CroptimizR/articles/Parameter_estimation_simple_case.html" class="uri">https://sticsrpacks.github.io/CroptimizR/articles/Parameter_estimation_simple_case.html</a>).</p></li>
</ul>
</div>
</div>
<div id="optional-issues" class="section level2">
<h2 class="hasAnchor">
<a href="#optional-issues" class="anchor"></a>Optional issues</h2>
<ul>
<li>
<p>Take into account different parameters values depending on the situation to simulate</p>
<p>If you want your model wrapper to be used for simultaneous estimation of specific and varietal parameters on a dataset including several cultivars (e.g. as in the example detailed in <a href="https://sticsrpacks.github.io/CroptimizR/articles/Parameter_estimation_Specific_and_Varietal.html" class="uri">https://sticsrpacks.github.io/CroptimizR/articles/Parameter_estimation_Specific_and_Varietal.html</a>), the <code>param_values</code> argument must be able to receive a data.frame (or tibble) including a specific column named <code>situation</code>. In this case, the different lines of the data.frame will specify the values of the parameters to use in the model for the situation given in the column <code>situation</code>, as in the example below:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a><span class="co"># A tibble: 4 x 4</span></span>
<span id="cb10-2"><a href="#cb10-2"></a>  situation  p1     p2     p3</span>
<span id="cb10-3"><a href="#cb10-3"></a>  <span class="op">&lt;</span>chr<span class="op">&gt;</span><span class="st">     </span><span class="er">&lt;</span>dbl<span class="op">&gt;</span><span class="st">  </span><span class="er">&lt;</span>dbl<span class="op">&gt;</span><span class="st">  </span><span class="er">&lt;</span>dbl<span class="op">&gt;</span></span>
<span id="cb10-4"><a href="#cb10-4"></a><span class="dv">1</span> sit1      <span class="fl">50.14</span>  <span class="fl">1.14</span>   <span class="fl">340.43</span></span>
<span id="cb10-5"><a href="#cb10-5"></a><span class="dv">2</span> sit2      <span class="fl">55.37</span>  <span class="fl">1.23</span>   <span class="fl">126.47</span></span>
<span id="cb10-6"><a href="#cb10-6"></a><span class="dv">3</span> sit3      <span class="fl">43.22</span>  <span class="fl">2.12</span>   <span class="fl">234.56</span></span>
<span id="cb10-7"><a href="#cb10-7"></a><span class="dv">4</span> sit4      <span class="fl">38.49</span>  <span class="fl">2.02</span>   <span class="fl">236.45</span></span></code></pre></div>
<p>Depending on the application (simple case or simultaneous specific and varietal parameters estimation), the <code>estim_param</code> function will thus pass to the model wrapper either a named vector or a data.frame, including or not the <code>situation</code> column. Both shapes have thus to be handled in the model wrapper in this case. This may be done as in the following piece of code:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># convert param_values in a tibble</span>
<span class="va">param_values</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span><span class="op">!</span><span class="op">!</span><span class="op">!</span><span class="va">param_values</span><span class="op">)</span> 

<span class="co"># loop on the situations to simulate </span>
<span class="kw">for</span> <span class="op">(</span><span class="va">sit</span> <span class="kw">in</span> <span class="va">situation_list</span><span class="op">)</span> <span class="op">{</span>

  <span class="co"># extract the parameters values to apply for the given situation</span>
  <span class="va">params</span> <span class="op">&lt;-</span> <span class="cn">NULL</span>
  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">param_values</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span> <span class="st">"situation"</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">param_values</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
      <span class="va">params</span> <span class="op">&lt;-</span> <span class="va">param_values</span>
    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
      <span class="va">params</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">param_values</span>, <span class="va">situation</span><span class="op">==</span><span class="va">sit</span><span class="op">)</span> <span class="op">%&gt;%</span> 
        <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">situation</span><span class="op">)</span>
    <span class="op">}</span>
  <span class="op">}</span>

  <span class="co"># run the model with parameters values defined by params</span>

<span class="op">}</span></code></pre></div>
</li>
<li>
<p>Check wrapper arguments:</p>
<p>If possible implement any check you can concerning what is given to the wrapper. Print a message using the <code>warning</code> function and return TRUE in <code>results$error</code> if a problem is detected. It may be an unknown parameter name given in <code>param_values</code>, an unknown situation name given in <code>sit_name</code>, an incorrect model option (field of <code>model_option</code>) such as an incorrect model path for example …</p>
</li>
<li>
<p>Perform parallel calculations:</p>
<p>If possible with your model (pay attention to concurrency access to model input and output files), managing parallel simulations of the different situations to simulate may drastically reduce the execution time.</p>
<p>The doParallel package can be used for that. There are specificities when coding a parallel loop: in particular, a list pre allocated outside of the loop is not shared between cores so return statements must be used inside. Here is an example for illustrating this issue:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Code of an example of foreach loop algo</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st">"doParallel"</span><span class="op">)</span></code></pre></div>
<pre><code>## Loading required package: foreach</code></pre>
<pre><code>## Loading required package: iterators</code></pre>
<pre><code>## Loading required package: parallel</code></pre>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">test_parallel</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">cores_nb</span> <span class="op">=</span> <span class="fl">1</span>,
                          <span class="va">pa</span> <span class="op">=</span> <span class="cn">FALSE</span>,
                          <span class="va">max_it</span> <span class="op">=</span> <span class="fl">5</span><span class="op">)</span> <span class="op">{</span>
<span class="co"># pa: flag to switch from case with pre-allocated list to case with returned statement</span>


  <span class="co"># Launching the cluster</span>
  <span class="va">cl</span> <span class="op">&lt;-</span> <span class="fu">makeCluster</span><span class="op">(</span><span class="va">cores_nb</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/pkg/doParallel/man/registerDoParallel.html">registerDoParallel</a></span><span class="op">(</span><span class="va">cl</span><span class="op">)</span>

  <span class="co"># List preallocation</span>
  <span class="va">out_pa</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">vector</a></span><span class="op">(</span>mode <span class="op">=</span> <span class="st">"list"</span>, <span class="va">max_it</span><span class="op">)</span>

  <span class="co"># Parallel loop</span>
  <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu">foreach</span><span class="op">(</span>i <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">max_it</span><span class="op">)</span> <span class="op">%dopar%</span> <span class="op">{</span>
    <span class="kw">if</span> <span class="op">(</span><span class="va">pa</span><span class="op">)</span> <span class="op">{</span>  
      <span class="va">out_pa</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">i</span>  <span class="co"># store results in a pre-allocted list</span>
    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
      <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">i</span><span class="op">)</span>         <span class="co"># return the results</span>
    <span class="op">}</span>
  <span class="op">}</span>

  <span class="co"># Stopping the cluster</span>
  <span class="fu">stopCluster</span><span class="op">(</span><span class="va">cl</span><span class="op">)</span>

  <span class="kw">if</span> <span class="op">(</span><span class="va">pa</span><span class="op">)</span> <span class="op">{</span>
    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">out_pa</span><span class="op">)</span>
  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span>
  <span class="op">}</span>


<span class="op">}</span>

<span class="va">cores_nb</span><span class="op">=</span><span class="fl">2</span>

<span class="co"># Case with returned statement</span>
<span class="va">out</span> <span class="op">&lt;-</span> <span class="fu">test_parallel</span><span class="op">(</span><span class="va">cores_nb</span><span class="op">)</span>

<span class="co"># Case with pre-allocated list</span>
<span class="va">out_pa</span> <span class="op">&lt;-</span> <span class="fu">test_parallel</span><span class="op">(</span><span class="va">cores_nb</span>, <span class="cn">TRUE</span><span class="op">)</span>

<span class="va">out</span></code></pre></div>
<pre><code>## [[1]]
## [1] 1
## 
## [[2]]
## [1] 2
## 
## [[3]]
## [1] 3
## 
## [[4]]
## [1] 4
## 
## [[5]]
## [1] 5</code></pre>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">out_pa</span></code></pre></div>
<pre><code>## [[1]]
## NULL
## 
## [[2]]
## NULL
## 
## [[3]]
## NULL
## 
## [[4]]
## NULL
## 
## [[5]]
## NULL</code></pre>
</li>
<li>
<p>Outputs selection</p>
<p>Two additional arguments (<code>var_names</code> and <code>sit_var_dates_mask</code>) can be defined in the wrapper and are provided by the <code>estim_param</code> function when it calls the wrapper. They can be used to select the results to return and are particularly useful if this selection allows saving computation time or memory (for example if model results are read in a databasis with specific request per variable and/or date, or if model results are read in different files depending on the variables …).</p>
<p><code>var_names</code> is a vector of variables names for which results must be returned.</p>
<p><code>sit_var_dates_mask</code> is a list of data.frame similar to <code>results$sim_list</code>. It indicates the list of variables and dates for each situation for which results must be returned: if <code>sit_var_dates_mask$situation1[j,"var1"]</code> does not contain NA, then the simulated value of variable “var1” at date <code>sit_var_dates_mask$situation1[j,"Date"]</code> must be returned in <code>results$sim_list[["situation1"]]</code>.</p>
<p>It is advised to define them as optionnal arguments with default value equal to NULL. If not given or if they are NULL, the wrapper should return results for all simulated variables. If both arguments are handled in the model wrapper code (which is not mandatory: none of them or only one of them can be handled) and non-null values are given for both, only <code>sit_var_dates_mask</code> should be taken into account since it is more detailed.</p>
</li>
</ul>
</div>
<div id="examples" class="section level2">
<h2 class="hasAnchor">
<a href="#examples" class="anchor"></a>Examples</h2>
<div id="example-of-a-basic-wrapper-for-an-lai-toy-model" class="section level3">
<h3 class="hasAnchor">
<a href="#example-of-a-basic-wrapper-for-an-lai-toy-model" class="anchor"></a>Example of a basic wrapper for an LAI toy model</h3>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">lai_toymodel</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">year</span>, <span class="va">max_lai</span><span class="op">=</span><span class="fl">8</span>, <span class="va">julday_incslope</span><span class="op">=</span><span class="fl">100</span>, <span class="va">inc_slope</span><span class="op">=</span><span class="fl">5</span>, 
                         <span class="va">julday_decslope</span><span class="op">=</span><span class="fl">200</span>, <span class="va">dec_slope</span><span class="op">=</span><span class="fl">2</span><span class="op">)</span> <span class="op">{</span>
  <span class="co"># Simulate lai for a single crop over 2 years (from 01/01/year to 31/12/(year+1) </span>
  <span class="co"># with a simple double-logistic function </span>
  <span class="co">#</span>
  <span class="co"># Arguments</span>
  <span class="co">#   - year: first year of simulation </span>
  <span class="co">#   - max_lai: max value for lai</span>
  <span class="co">#   - inc_slope and dec_slope: increasing and decreasing slope</span>
  <span class="co">#   - julday_incslope and julday_decslope: julian days of maximal increasing and </span>
  <span class="co">#     decreasing slopes</span>
  <span class="co"># </span>
  <span class="co"># Value</span>
  <span class="co">#   - lai: vector of simulated lai</span>
  <span class="co">#   - dates: vector of dates (POSIXct) for which lai is computed</span>
  
  <span class="va">end_day</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/format.html">format</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">year</span><span class="op">+</span><span class="fl">1</span>,<span class="st">"-12-31"</span><span class="op">)</span>, format <span class="op">=</span> <span class="st">"%Y-%m-%d"</span>, origin<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">year</span>,<span class="st">"-01-01"</span><span class="op">)</span><span class="op">)</span>, <span class="st">"%j"</span><span class="op">)</span>
  <span class="va">jul_days</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">end_day</span><span class="op">)</span>
  
  <span class="va">lai</span> <span class="op">&lt;-</span> <span class="va">max_lai</span> <span class="op">*</span> <span class="op">(</span> <span class="fl">1</span><span class="op">/</span><span class="op">(</span><span class="fl">1</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="op">(</span><span class="va">julday_incslope</span><span class="op">-</span><span class="va">jul_days</span><span class="op">)</span><span class="op">/</span><span class="va">inc_slope</span><span class="op">)</span><span class="op">)</span> <span class="op">-</span> 
                     <span class="fl">1</span><span class="op">/</span><span class="op">(</span><span class="fl">1</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="op">(</span><span class="va">julday_decslope</span><span class="op">-</span><span class="va">jul_days</span><span class="op">)</span><span class="op">/</span><span class="va">dec_slope</span><span class="op">)</span><span class="op">)</span> <span class="op">)</span> 
  <span class="va">lai</span><span class="op">[</span><span class="va">lai</span><span class="op">&lt;</span><span class="fl">0</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span>
  
  <span class="va">dates</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html">as.POSIXct</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="va">jul_days</span>,
                                           origin<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">year</span>,<span class="st">"-01-01"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,
                      format <span class="op">=</span> <span class="st">"%Y-%m-%d"</span>,tz<span class="op">=</span><span class="st">"UTC"</span><span class="op">)</span>
  
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>dates<span class="op">=</span><span class="va">dates</span>, lai<span class="op">=</span><span class="va">lai</span><span class="op">)</span><span class="op">)</span>
  
<span class="op">}</span>


<span class="va">laitm_simple_wrapper</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">param_values</span><span class="op">=</span><span class="cn">NULL</span>, <span class="va">sit_names</span>, <span class="va">model_options</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span>
  
  <span class="co"># A basic wrapper for lai_toymodel  </span>
  <span class="co">#</span>
  <span class="co"># Arguments</span>
  <span class="co">#   - param_values: (optional) named vector containing the values of the lay_toymodel </span>
  <span class="co">#     parameters to force among max_lai, inc_slope, dec_slope, julday_incslope and </span>
  <span class="co">#     julday_decslope </span>
  <span class="co">#   - sit_names: Vector of situations names for which results must be returned.</span>
  <span class="co">#     In this case, the names of the situations are coded as "year_suffix" </span>
  <span class="co">#   - model_options: not used in this case</span>
  <span class="co">#   - ...: mandatory since CroptimizR will give additional arguments not used here</span>
  <span class="co">#</span>
  <span class="co"># Value:</span>
  <span class="co">#   A named list of tibble per situation. </span>
  <span class="co">#   Each tibble contains columns:</span>
  <span class="co">#      - Date (POSIXct dates of simulated results), </span>
  <span class="co">#      - One column per simulated variable (lai in this case)</span>
  <span class="co"># </span>
  <span class="co"># Details:</span>
  <span class="co">#  - Runs the lai_toymodel for a set of situations defined in sit_names </span>
  <span class="co">#  - Forces the parameters of lai_toymodel with the values given in param_values </span>
  <span class="co">#    argument   </span>
  <span class="co">#  - Returns the required simulated values</span>
  <span class="co">#</span>
  
  <span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>sim_list <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html">setNames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/vector.html">vector</a></span><span class="op">(</span><span class="st">"list"</span>,<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">sit_names</span><span class="op">)</span><span class="op">)</span>, nm <span class="op">=</span> <span class="va">sit_names</span><span class="op">)</span>,
                 error<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">results</span><span class="op">$</span><span class="va">sim_list</span>, <span class="st">"class"</span><span class="op">)</span><span class="op">=</span> <span class="st">"cropr_simulation"</span>

  <span class="kw">for</span> <span class="op">(</span><span class="va">sit</span> <span class="kw">in</span> <span class="va">sit_names</span><span class="op">)</span> <span class="op">{</span>
    
    <span class="co"># Retrieve year, emergence and crop_duration from situation name</span>
    <span class="va">tmp</span> <span class="op">&lt;-</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_split.html">str_split</a></span><span class="op">(</span><span class="va">sit</span>,<span class="st">"_"</span><span class="op">)</span>
    <span class="va">year</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">tmp</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>

    <span class="co"># Check inputs</span>
    <span class="kw">if</span> <span class="op">(</span><span class="va">year</span><span class="op">&lt;</span><span class="fl">1</span><span class="op">)</span> <span class="op">{</span>
      <span class="kw"><a href="https://rdrr.io/r/base/warning.html">warning</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"sit_name"</span>,<span class="va">sit</span>,
                    <span class="st">"not well defined, first part is supposed to be a year!"</span><span class="op">)</span><span class="op">)</span>
      <span class="va">results</span><span class="op">$</span><span class="va">error</span><span class="op">=</span><span class="cn">TRUE</span>
      <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">results</span><span class="op">)</span>
    <span class="op">}</span>
    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/all.html">all</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">param_values</span><span class="op">)</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"max_lai"</span>, <span class="st">"inc_slope"</span>, <span class="st">"dec_slope"</span>, 
                                        <span class="st">"julday_incslope"</span>, <span class="st">"julday_decslope"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
      <span class="kw"><a href="https://rdrr.io/r/base/warning.html">warning</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"Unknown parameters in param_values:"</span>,
                    <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">param_values</span><span class="op">)</span>,collapse <span class="op">=</span> <span class="st">","</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
      <span class="va">results</span><span class="op">$</span><span class="va">error</span><span class="op">=</span><span class="cn">TRUE</span>
      <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">results</span><span class="op">)</span>
    <span class="op">}</span>
    
    <span class="co"># Call the lai_toymodel with varying arguments depending on what is given in </span>
    <span class="co"># param_values</span>
    <span class="va">res_laitm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="st">'lai_toymodel'</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">as.list</a></span><span class="op">(</span><span class="va">param_values</span><span class="op">)</span>, 
                                           <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>year<span class="op">=</span><span class="va">year</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
    
    <span class="co"># Fill the result variable</span>
    <span class="va">results</span><span class="op">$</span><span class="va">sim_list</span><span class="op">[[</span><span class="va">sit</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>Date<span class="op">=</span><span class="va">res_laitm</span><span class="op">$</span><span class="va">dates</span>, 
                                              lai<span class="op">=</span><span class="va">res_laitm</span><span class="op">$</span><span class="va">lai</span><span class="op">)</span>
    
  <span class="op">}</span>
  
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">results</span><span class="op">)</span>

<span class="op">}</span></code></pre></div>
<p>Testing this wrapper using the test_wrapper function:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/SticsRPacks/CroptimizR">CroptimizR</a></span><span class="op">)</span>

<span class="fu"><a href="../reference/test_wrapper.html">test_wrapper</a></span><span class="op">(</span>model_function <span class="op">=</span> <span class="va">laitm_simple_wrapper</span>, model_options <span class="op">=</span> <span class="cn">NULL</span>, 
             param_values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>inc_slope<span class="op">=</span><span class="fl">25</span>, dec_slope<span class="op">=</span><span class="fl">10</span><span class="op">)</span>, sit_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"2005_a"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## Test the wrapper returns outputs in expected format ...
## ... OK
## 
## Test the wrapper gives identical results when running with same inputs ...
## ... OK
## 
## Test the wrapper gives different results when running with different inputs ...
## ... OK</code></pre>
<p>The little piece of code below shows an example of parameter estimation using this wrapper:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/SticsRPacks/CroptimizR">CroptimizR</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span>


<span class="va">tmp</span> <span class="op">&lt;-</span> <span class="fu">laitm_simple_wrapper</span><span class="op">(</span>sit_names<span class="op">=</span><span class="st">"2005_a"</span>, param_values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>inc_slope<span class="op">=</span><span class="fl">25</span>, dec_slope<span class="op">=</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span>

<span class="co"># Create synthetic observations by selecting simulated results</span>
<span class="va">ind</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">tmp</span><span class="op">$</span><span class="va">sim_list</span><span class="op">$</span><span class="va">`2005_a`</span><span class="op">)</span>,<span class="fl">50</span><span class="op">)</span><span class="op">)</span>
<span class="va">obs_synth</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>`2005_a`<span class="op">=</span><span class="va">tmp</span><span class="op">$</span><span class="va">sim_list</span><span class="op">$</span><span class="va">`2005_a`</span><span class="op">[</span><span class="va">ind</span>,<span class="op">]</span><span class="op">)</span>

<span class="co"># Try to retrieve inc_slope and dec_slope values</span>
<span class="va">param_info</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>lb<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>inc_slope<span class="op">=</span><span class="fl">1</span>,dec_slope<span class="op">=</span><span class="fl">1</span><span class="op">)</span>, ub<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>inc_slope<span class="op">=</span><span class="fl">100</span>,dec_slope<span class="op">=</span><span class="fl">100</span><span class="op">)</span><span class="op">)</span>
<span class="va">optim_options</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>nb_rep<span class="op">=</span><span class="fl">5</span>, maxeval<span class="op">=</span><span class="fl">100</span>, xtol_rel<span class="op">=</span><span class="fl">1e-2</span><span class="op">)</span>
<span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/estim_param.html">estim_param</a></span><span class="op">(</span><span class="va">obs_synth</span>, crit_function <span class="op">=</span> <span class="va">crit_ols</span>,
            model_function <span class="op">=</span> <span class="va">laitm_simple_wrapper</span>,
            optim_options<span class="op">=</span><span class="va">optim_options</span>,
            param_info <span class="op">=</span> <span class="va">param_info</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "Working: 20.00%. ETA: 1.61"
## [1] "Working: 40.00%. ETA: 1.10"
## [1] "Working: 60.00%. ETA: 0.77"
## [1] "Working: 80.00%. ETA: 0.38"
## [1] "Working: 100.00%. ETA: 0.00"
## $inc_slope</code></pre>
<pre><code>## 
## $dec_slope</code></pre>
<pre><code>## 
## [1] "Estimated value for inc_slope :  24.9863167650791"
## [1] "Estimated value for dec_slope :  9.96813295321121"
## [1] "Minimum value of the criterion: 0.000182548150477414"
## [1] "Complementary graphs and results can be found in  /Users/runner/work/CroptimizR/CroptimizR/vignettes"
## Total time for parameter estimation: 2.394 sec elapsed</code></pre>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">res</span><span class="op">$</span><span class="va">final_values</span></code></pre></div>
<pre><code>## inc_slope dec_slope 
## 24.986317  9.968133</code></pre>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Plot the simulations obtained with the optimized values of the parameters VS the observed ones using the CroPlotR package.</span>
<span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html">require</a></span><span class="op">(</span><span class="st"><a href="https://github.com/SticsRPacks/CroPlotR">"CroPlotR"</a></span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
    <span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://devtools.r-lib.org//reference/remote-reexports.html">install_github</a></span><span class="op">(</span><span class="st">"SticsRPacks/CroPlotR@*release"</span><span class="op">)</span>
    <span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://github.com/SticsRPacks/CroPlotR">"CroPlotR"</a></span><span class="op">)</span>
<span class="op">}</span>
<span class="va">tmp</span> <span class="op">&lt;-</span> <span class="fu">laitm_simple_wrapper</span><span class="op">(</span>sit_names<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"2005_a"</span>,<span class="st">"2006_b"</span><span class="op">)</span>,
                            param_values <span class="op">=</span> <span class="va">res</span><span class="op">$</span><span class="va">final_values</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">tmp</span><span class="op">$</span><span class="va">sim_list</span>,obs<span class="op">=</span><span class="va">obs_synth</span>,type<span class="op">=</span><span class="st">"scatter"</span><span class="op">)</span></code></pre></div>
<pre><code>## $all_situations</code></pre>
<p><img src="Designing_a_model_wrapper_files/figure-html/unnamed-chunk-10-1.png" width="700"></p>
</div>
<div id="another-version-taking-into-account-the-different-shapes-param_values-can-take" class="section level3">
<h3 class="hasAnchor">
<a href="#another-version-taking-into-account-the-different-shapes-param_values-can-take" class="anchor"></a>Another version taking into account the different shapes param_values can take</h3>
<p>This one can be used to perform simultaneous estimation of specific and varietal parameters on a dataset including several cultivars.</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">laitm_simple_wrapper_v2</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">param_values</span><span class="op">=</span><span class="cn">NULL</span>, <span class="va">sit_names</span>, <span class="va">model_options</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span>
  
  <span class="co"># A basic wrapper for lai_toymodel  </span>
  <span class="co">#</span>
  <span class="co"># Arguments</span>
  <span class="co">#   - param_values: (optional) a named vector or a tibble containing the values of the </span>
  <span class="co">#     lay_toymodel parameters to force among max_lai, inc_slope, dec_slope, </span>
  <span class="co">#     julday_incslope and julday_decslope. An optional column named Situation containing   </span>
  <span class="co">#     the name of the situations allows to define different values of the parameters</span>
  <span class="co">#     for different situations. </span>
  <span class="co">#   - sit_names: Vector of situations names for which results must be returned.</span>
  <span class="co">#     In this case, the names of the situations are coded as "year_suffix" </span>
  <span class="co">#   - model_options: not used in this case</span>
  <span class="co">#   - ...: mandatory since CroptimizR will give additional arguments not used here</span>
  <span class="co">#</span>
  <span class="co"># Value:</span>
  <span class="co">#   A named list of tibble per situation. </span>
  <span class="co">#   Each tibble contains columns:</span>
  <span class="co">#      - Date (POSIXct dates of simulated results), </span>
  <span class="co">#      - One column per simulated variable (lai in this case)</span>
  <span class="co"># </span>
  <span class="co"># Details:</span>
  <span class="co">#  - Runs the lai_toymodel for a set of situations defined in sit_names </span>
  <span class="co">#  - Forces the parameters of lai_toymodel with the values given in param_values </span>
  <span class="co">#   argument   </span>
  <span class="co">#  - Returns the required simulated values</span>
  <span class="co">#</span>
  
  <span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>sim_list <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html">setNames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/vector.html">vector</a></span><span class="op">(</span><span class="st">"list"</span>,<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">sit_names</span><span class="op">)</span><span class="op">)</span>, 
                                      nm <span class="op">=</span> <span class="va">sit_names</span><span class="op">)</span>, error<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">results</span><span class="op">$</span><span class="va">sim_list</span>, <span class="st">"class"</span><span class="op">)</span><span class="op">=</span> <span class="st">"cropr_simulation"</span>

  <span class="va">param_values</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span><span class="op">!</span><span class="op">!</span><span class="op">!</span><span class="va">param_values</span><span class="op">)</span>  <span class="co"># convert param_values in a tibble</span>
  
  <span class="kw">for</span> <span class="op">(</span><span class="va">sit</span> <span class="kw">in</span> <span class="va">sit_names</span><span class="op">)</span> <span class="op">{</span>
    
    <span class="co"># Retrieve year, emergence and crop_duration from situation name</span>
    <span class="va">tmp</span> <span class="op">&lt;-</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_split.html">str_split</a></span><span class="op">(</span><span class="va">sit</span>,<span class="st">"_"</span><span class="op">)</span>
    <span class="va">year</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">tmp</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>

    <span class="co"># Check inputs</span>
    <span class="kw">if</span> <span class="op">(</span><span class="va">year</span><span class="op">&lt;</span><span class="fl">1</span><span class="op">)</span> <span class="op">{</span>
      <span class="kw"><a href="https://rdrr.io/r/base/warning.html">warning</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"sit_name"</span>,<span class="va">sit</span>,
                    <span class="st">"not well defined, first part is supposed to be a year!"</span><span class="op">)</span><span class="op">)</span>
      <span class="va">results</span><span class="op">$</span><span class="va">error</span><span class="op">=</span><span class="cn">TRUE</span>
      <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">results</span><span class="op">)</span>
    <span class="op">}</span>
    
    <span class="co"># extract the parameters values to apply for the given situation</span>
    <span class="va">params</span> <span class="op">&lt;-</span> <span class="cn">NULL</span>
    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">param_values</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
      <span class="kw">if</span> <span class="op">(</span><span class="op">!</span> <span class="st">"situation"</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">param_values</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
        <span class="va">params</span> <span class="op">&lt;-</span> <span class="va">param_values</span>
      <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
        <span class="va">params</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">param_values</span>, <span class="va">situation</span><span class="op">==</span><span class="va">sit</span><span class="op">)</span> <span class="op">%&gt;%</span> 
          <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">situation</span><span class="op">)</span>
      <span class="op">}</span>
    <span class="op">}</span>
    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/all.html">all</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">params</span><span class="op">)</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"max_lai"</span>, <span class="st">"inc_slope"</span>, <span class="st">"dec_slope"</span>, 
                                  <span class="st">"julday_incslope"</span>, <span class="st">"julday_decslope"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
      <span class="kw"><a href="https://rdrr.io/r/base/warning.html">warning</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"Unknown parameters in param_values:"</span>,
                    <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">param_values</span><span class="op">)</span>,collapse <span class="op">=</span> <span class="st">","</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
      <span class="va">results</span><span class="op">$</span><span class="va">error</span><span class="op">=</span><span class="cn">TRUE</span>
      <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">results</span><span class="op">)</span>
    <span class="op">}</span>

    <span class="co"># Call the lai_toymodel with varying arguments depending on what is given in </span>
    <span class="co"># param_values</span>
    <span class="va">res_laitm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="st">'lai_toymodel'</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">as.list</a></span><span class="op">(</span><span class="va">params</span><span class="op">)</span>, 
                                           <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>year<span class="op">=</span><span class="va">year</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
    
    <span class="co"># Fill the result variable</span>
    <span class="va">results</span><span class="op">$</span><span class="va">sim_list</span><span class="op">[[</span><span class="va">sit</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>Date<span class="op">=</span><span class="va">res_laitm</span><span class="op">$</span><span class="va">dates</span>, 
                                              lai<span class="op">=</span><span class="va">res_laitm</span><span class="op">$</span><span class="va">lai</span><span class="op">)</span>
    
  <span class="op">}</span>
  
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">results</span><span class="op">)</span>

<span class="op">}</span></code></pre></div>
<p>Testing this wrapper using the test_wrapper function:</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/SticsRPacks/CroptimizR">CroptimizR</a></span><span class="op">)</span>

<span class="fu"><a href="../reference/test_wrapper.html">test_wrapper</a></span><span class="op">(</span>model_function <span class="op">=</span> <span class="va">laitm_simple_wrapper_v2</span>, model_options <span class="op">=</span> <span class="cn">NULL</span>, 
             param_values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>inc_slope<span class="op">=</span><span class="fl">25</span>, dec_slope<span class="op">=</span><span class="fl">10</span><span class="op">)</span>, sit_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"2005_a"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## Test the wrapper returns outputs in expected format ...
## ... OK
## 
## Test the wrapper gives identical results when running with same inputs ...
## ... OK
## 
## Test the wrapper gives different results when running with different inputs ...
## ... OK</code></pre>
<p>The code below shows an example of a simultaneous estimation of specific (dec_slope here) and varietal (inc_slope) parameters using this wrapper:</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/SticsRPacks/CroptimizR">CroptimizR</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span>

<span class="va">tmp</span> <span class="op">&lt;-</span> <span class="fu">laitm_simple_wrapper_v2</span><span class="op">(</span>sit_names<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"2005_a"</span>,<span class="st">"2006_b"</span><span class="op">)</span>,
                            param_values <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>situation<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"2005_a"</span>,<span class="st">"2006_b"</span><span class="op">)</span>,
                                                  inc_slope<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">25</span>,<span class="fl">50</span><span class="op">)</span>, dec_slope<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">10</span>,<span class="fl">10</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

<span class="co"># Create synthetic observations by selecting simulated results</span>
<span class="va">length_2005_a</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">tmp</span><span class="op">$</span><span class="va">sim_list</span><span class="op">$</span><span class="va">`2005_a`</span><span class="op">)</span>
<span class="va">length_2006_b</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">tmp</span><span class="op">$</span><span class="va">sim_list</span><span class="op">$</span><span class="va">`2006_b`</span><span class="op">)</span>
<span class="va">obs_synth</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>`2005_a`<span class="op">=</span><span class="va">tmp</span><span class="op">$</span><span class="va">sim_list</span><span class="op">$</span><span class="va">`2005_a`</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span>from<span class="op">=</span><span class="fl">1</span>, to<span class="op">=</span><span class="va">length_2005_a</span>, by<span class="op">=</span><span class="fl">3</span><span class="op">)</span>,<span class="op">]</span>,
                  `2006_b`<span class="op">=</span><span class="va">tmp</span><span class="op">$</span><span class="va">sim_list</span><span class="op">$</span><span class="va">`2006_b`</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span>from<span class="op">=</span><span class="fl">1</span>, to<span class="op">=</span><span class="va">length_2006_b</span>, by<span class="op">=</span><span class="fl">3</span><span class="op">)</span>,<span class="op">]</span><span class="op">)</span>

<span class="co"># Try to retrieve inc_slope and dec_slope values on both situations</span>
<span class="va">param_info</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>inc_slope<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>sit_list<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">"2005_a"</span>,<span class="st">"2006_b"</span><span class="op">)</span>,
                          lb<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span>,ub<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">100</span>,<span class="fl">100</span><span class="op">)</span><span class="op">)</span>,
                dec_slope<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>sit_list<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"2005_a"</span>,<span class="st">"2006_b"</span><span class="op">)</span><span class="op">)</span>,
                          lb<span class="op">=</span><span class="fl">1</span>,ub<span class="op">=</span><span class="fl">100</span><span class="op">)</span><span class="op">)</span>

<span class="va">optim_options</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>nb_rep<span class="op">=</span><span class="fl">5</span>, maxeval<span class="op">=</span><span class="fl">100</span>, xtol_rel<span class="op">=</span><span class="fl">1e-2</span><span class="op">)</span>
<span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/estim_param.html">estim_param</a></span><span class="op">(</span><span class="va">obs_synth</span>, crit_function <span class="op">=</span> <span class="va">crit_ols</span>,
            model_function <span class="op">=</span> <span class="va">laitm_simple_wrapper_v2</span>,
            optim_options<span class="op">=</span><span class="va">optim_options</span>,
            param_info <span class="op">=</span> <span class="va">param_info</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "Working: 20.00%. ETA: 7.17"
## [1] "Working: 40.00%. ETA: 5.42"
## [1] "Working: 60.00%. ETA: 3.81"
## [1] "Working: 80.00%. ETA: 2.03"
## [1] "Working: 100.00%. ETA: 0.00"
## $inc_slope1</code></pre>
<pre><code>## 
## $inc_slope2</code></pre>
<pre><code>## 
## $dec_slope</code></pre>
<pre><code>## 
## [1] "Estimated value for inc_slope1 :  25.0347034291651"
## [1] "Estimated value for inc_slope2 :  49.9455492141385"
## [1] "Estimated value for dec_slope :  9.95712483751609"
## [1] "Minimum value of the criterion: 0.00195900739600454"
## [1] "Complementary graphs and results can be found in  /Users/runner/work/CroptimizR/CroptimizR/vignettes"
## Total time for parameter estimation: 11.033 sec elapsed</code></pre>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">res</span><span class="op">$</span><span class="va">final_values</span></code></pre></div>
<pre><code>## inc_slope1 inc_slope2  dec_slope 
##  25.034703  49.945549   9.957125</code></pre>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Plot the simulations obtained with the optimized values of the parameters VS the observed ones using the CroPlotR package.</span>
<span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html">require</a></span><span class="op">(</span><span class="st"><a href="https://github.com/SticsRPacks/CroPlotR">"CroPlotR"</a></span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
    <span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://devtools.r-lib.org//reference/remote-reexports.html">install_github</a></span><span class="op">(</span><span class="st">"SticsRPacks/CroPlotR@*release"</span><span class="op">)</span>
    <span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://github.com/SticsRPacks/CroPlotR">"CroPlotR"</a></span><span class="op">)</span>
<span class="op">}</span>
<span class="va">tmp</span> <span class="op">&lt;-</span> <span class="fu">laitm_simple_wrapper_v2</span><span class="op">(</span>sit_names<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"2005_a"</span>,<span class="st">"2006_b"</span><span class="op">)</span>,
                            param_values <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>situation<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"2005_a"</span>,<span class="st">"2006_b"</span><span class="op">)</span>,
                                                  inc_slope<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">res</span><span class="op">$</span><span class="va">final_values</span><span class="op">[[</span><span class="st">"inc_slope1"</span><span class="op">]</span><span class="op">]</span>,<span class="va">res</span><span class="op">$</span><span class="va">final_values</span><span class="op">[[</span><span class="st">"inc_slope2"</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>, dec_slope<span class="op">=</span><span class="va">res</span><span class="op">$</span><span class="va">final_values</span><span class="op">[[</span><span class="st">"dec_slope"</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">tmp</span><span class="op">$</span><span class="va">sim_list</span>,obs<span class="op">=</span><span class="va">obs_synth</span>,type<span class="op">=</span><span class="st">"scatter"</span><span class="op">)</span></code></pre></div>
<pre><code>## $all_situations</code></pre>
<p><img src="Designing_a_model_wrapper_files/figure-html/unnamed-chunk-13-1.png" width="700"></p>
</div>
<div id="other-examples" class="section level3">
<h3 class="hasAnchor">
<a href="#other-examples" class="anchor"></a>Other examples</h3>
<p>More complex examples of crop model wrappers for CroptimizR can be found in the SticsOnR package <a href="https://github.com/SticsRPacks/SticsOnR/blob/master/R/stics_wrapper.R" class="uri">https://github.com/SticsRPacks/SticsOnR/blob/master/R/stics_wrapper.R</a> for the Stics model and in the ApsimOnR package <a href="https://github.com/hol430/ApsimOnR/blob/master/R/apsimx_wrapper.R" class="uri">https://github.com/hol430/ApsimOnR/blob/master/R/apsimx_wrapper.R</a> for ApsimX model.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Samuel Buis, Michel Giner, Patrice Lecharpentier, SticsRpacks.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
